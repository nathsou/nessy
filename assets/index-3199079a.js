(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function r(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=r(s);fetch(s.href,a)}})();let S,W=null;function j(){return(W===null||W.byteLength===0)&&(W=new Uint8Array(S.memory.buffer)),W}function we(e,t){return e=e>>>0,j().subarray(e/1,e/1+t)}const M=new Array(128).fill(void 0);M.push(void 0,null,!0,!1);function q(e){return M[e]}let X=M.length;function Ie(e){e<132||(M[e]=X,X=e)}function se(e){const t=q(e);return Ie(e),t}const he=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&he.decode();function ne(e,t){return e=e>>>0,he.decode(j().subarray(e,e+t))}function V(e){X===M.length&&M.push(M.length+1);const t=X;return X=M[t],M[t]=e,t}let P=0;function re(e,t){const r=t(e.length*1,1)>>>0;return j().set(e,r/1),P=e.length,r}let K=null;function U(){return(K===null||K.byteLength===0)&&(K=new Int32Array(S.memory.buffer)),K}let $=null;function Ee(){return($===null||$.byteLength===0)&&($=new Float32Array(S.memory.buffer)),$}function le(e,t){const r=t(e.length*4,4)>>>0;return Ee().set(e,r/4),P=e.length,r}const Q=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},Te=typeof Q.encodeInto=="function"?function(e,t){return Q.encodeInto(e,t)}:function(e,t){const r=Q.encode(e);return t.set(r),{read:e.length,written:r.length}};function Le(e,t,r){if(r===void 0){const i=Q.encode(e),d=t(i.length,1)>>>0;return j().subarray(d,d+i.length).set(i),P=i.length,d}let n=e.length,s=t(n,1)>>>0;const a=j();let o=0;for(;o<n;o++){const i=e.charCodeAt(o);if(i>127)break;a[s+o]=i}if(o!==n){o!==0&&(e=e.slice(o)),s=r(s,n,n=o+e.length*3,1)>>>0;const i=j().subarray(s+o,s+n),d=Te(e,i);o+=d.written}return P=o,s}class H{static __wrap(t){t=t>>>0;const r=Object.create(H.prototype);return r.__wbg_ptr=t,r}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();S.__wbg_nes_free(t)}static initPanicHook(){S.nes_initPanicHook()}static new(t,r){try{const o=S.__wbindgen_add_to_stack_pointer(-16),i=re(t,S.__wbindgen_malloc),d=P;S.nes_new(o,i,d,r);var n=U()[o/4+0],s=U()[o/4+1],a=U()[o/4+2];if(a)throw se(s);return H.__wrap(n)}finally{S.__wbindgen_add_to_stack_pointer(16)}}softReset(){S.nes_softReset(this.__wbg_ptr)}nextFrame(){S.nes_nextFrame(this.__wbg_ptr)}nextSamples(t){var r=le(t,S.__wbindgen_malloc),n=P;return S.nes_nextSamples(this.__wbg_ptr,r,n,V(t))!==0}fillFrameBuffer(t){var r=re(t,S.__wbindgen_malloc),n=P;S.nes_fillFrameBuffer(this.__wbg_ptr,r,n,V(t))}getUpdatedTilesCount(){return S.nes_getUpdatedTilesCount(this.__wbg_ptr)>>>0}setJoypad1(t){S.nes_setJoypad1(this.__wbg_ptr,t)}setJoypad2(t){S.nes_setJoypad2(this.__wbg_ptr,t)}saveState(){try{const s=S.__wbindgen_add_to_stack_pointer(-16);S.nes_saveState(s,this.__wbg_ptr);var t=U()[s/4+0],r=U()[s/4+1],n=we(t,r).slice();return S.__wbindgen_free(t,r*1),n}finally{S.__wbindgen_add_to_stack_pointer(16)}}loadState(t){try{const s=S.__wbindgen_add_to_stack_pointer(-16),a=re(t,S.__wbindgen_malloc),o=P;S.nes_loadState(s,this.__wbg_ptr,a,o);var r=U()[s/4+0],n=U()[s/4+1];if(n)throw se(r)}finally{S.__wbindgen_add_to_stack_pointer(16)}}fillAudioBuffer(t,r){var n=le(t,S.__wbindgen_malloc),s=P;S.nes_fillAudioBuffer(this.__wbg_ptr,n,s,V(t),r)}clearAudioBuffer(){S.nes_clearAudioBuffer(this.__wbg_ptr)}}async function Re(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(n){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}const r=await e.arrayBuffer();return await WebAssembly.instantiate(r,t)}else{const r=await WebAssembly.instantiate(e,t);return r instanceof WebAssembly.Instance?{instance:r,module:e}:r}}function ke(){const e={};return e.wbg={},e.wbg.__wbindgen_copy_to_typed_array=function(t,r,n){new Uint8Array(q(n).buffer,q(n).byteOffset,q(n).byteLength).set(we(t,r))},e.wbg.__wbindgen_object_drop_ref=function(t){se(t)},e.wbg.__wbindgen_string_new=function(t,r){const n=ne(t,r);return V(n)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){const t=new Error;return V(t)},e.wbg.__wbg_stack_658279fe44541cf6=function(t,r){const n=q(r).stack,s=Le(n,S.__wbindgen_malloc,S.__wbindgen_realloc),a=P;U()[t/4+1]=a,U()[t/4+0]=s},e.wbg.__wbg_error_f851667af71bcfc6=function(t,r){let n,s;try{n=t,s=r,console.error(ne(t,r))}finally{S.__wbindgen_free(n,s,1)}},e.wbg.__wbindgen_throw=function(t,r){throw new Error(ne(t,r))},e}function Pe(e,t){return S=e.exports,ye.__wbindgen_wasm_module=t,$=null,K=null,W=null,S}async function ye(e){if(S!==void 0)return S;typeof e>"u"&&(e=new URL("/nessy/wasm/nessy_web_bg.wasm",self.location));const t=ke();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:r,module:n}=await Re(await e,t);return Pe(r,n)}const Ue=()=>{const e={};return{register(t,r){if(e[t]!=null)throw new Error(`Hook ${String(t)} is already registered`);e[t]=r},call(t,...r){const n=e[t];if(n!=null)return n.apply(null,r);throw new Error(`Hook ${String(t)} is not registered`)}}},b=Ue();var I=(e=>(e[e.A=1]="A",e[e.B=2]="B",e[e.SELECT=4]="SELECT",e[e.START=8]="START",e[e.UP=16]="UP",e[e.DOWN=32]="DOWN",e[e.LEFT=64]="LEFT",e[e.RIGHT=128]="RIGHT",e))(I||{});const N={up:16,left:64,down:32,right:128,b:2,a:1,start:8,select:4},ae={16:"up",64:"left",32:"down",128:"right",2:"b",1:"a",8:"start",4:"select"},Me={inputs:{up:"w",left:"a",down:"s",right:"d",b:"k",a:"l",start:"Enter",select:" "},meta:{toggleUI:"Escape",save:"META+s",loadLastSave:"META+l"}},Oe=17,De={inputs:{up:12,left:14,down:13,right:15,b:0,a:1,start:9,select:8},meta:{toggleUI:6,save:10,loadLastSave:11}},Fe={keyboard:Me,gamepad:De},_e=(e=Fe)=>{const t={keyboard:{inputs:{},meta:{}},gamepad:{inputs:{},meta:{}}},r=()=>JSON.stringify(e),n=s=>{for(const[a,o]of Object.entries(s.keyboard.inputs))s.keyboard.inputs[a]=o,t.keyboard.inputs[o]=N[a];for(const[a,o]of Object.entries(s.keyboard.meta))s.keyboard.meta[a]=o,t.keyboard.meta[o]=N[a];for(const[a,o]of Object.entries(s.gamepad.inputs))s.gamepad.inputs[a]=o,t.gamepad.inputs[o]=N[a];for(const[a,o]of Object.entries(s.gamepad.meta))s.gamepad.meta[a]=o,t.gamepad.meta[o]=N[a]};return n(e),{ref:e,reversed:t,setKeyboard(s,a){delete t.keyboard.inputs[e.keyboard.inputs[a]],t.keyboard.inputs[s]=N[a],e.keyboard.inputs[a]=s},setGamepad(s,a){delete t.gamepad.inputs[e.gamepad.inputs[a]],t.gamepad.inputs[s]=N[a],e.gamepad.inputs[a]=s},getKeyboard(s){return t.keyboard.inputs[s]??null},getGamepad(s){return t.gamepad.inputs[s]??null},isKeyMapped(s){return s in t.keyboard.inputs},isInputMapped(s){return s in t.gamepad.inputs},serialize:r,update:n}},Ce=e=>{let t=!1,r=-1,n=0,s=0;const a={inputs:{up:!1,left:!1,down:!1,right:!1,b:!1,a:!1,start:!1,select:!1},meta:{toggleUI:!1,save:!1,loadLastSave:!1}};async function o(l,g){if(l.key==="Meta"&&(t=g,l.preventDefault()),g&&(l.key==="Escape"||l.key==="Tab")?(l.preventDefault(),a.meta.toggleUI||(b.call("toggleUI"),a.meta.toggleUI=!0)):a.meta.toggleUI=!1,t&&g)switch(l.key){case"s":{if(l.preventDefault(),!a.meta.save){b.call("saveState"),a.meta.save=!0;return}break}case"r":{l.preventDefault(),b.call("softReset");return}case"l":{if(l.preventDefault(),!a.meta.loadLastSave){await b.call("loadLastSave"),a.meta.loadLastSave=!0;return}break}default:a.meta.save=!1,a.meta.loadLastSave=!1,l.preventDefault()}if(e.ref.controls.isKeyMapped(l.key)){(l.key==="Enter"||l.key===" ")&&l.preventDefault();const w=e.ref.controls.getKeyboard(l.key),h=ae[w];g?n|=w:n&=~w,a.inputs[h]!==g&&(b.call("input",h),a.inputs[h]=g)}}const i=l=>o(l,!0),d=l=>o(l,!1);function u(){if(r>=0){const l=navigator.getGamepads()[r];let g=s;for(let E=0;E<16;E++){const k=l.buttons[E];if(e.ref.controls.isInputMapped(E)){const m=e.ref.controls.getGamepad(E),v=ae[m];k.pressed?g|=m:g&=~m,a.inputs[v]!==k.pressed&&k.pressed&&b.call("input",v,E),a.inputs[v]=k.pressed}}for(let E=0;E<4;E++){const k=l.axes[E],m=Oe+2*E+(k<0?0:1);if(e.ref.controls.isInputMapped(m)){const v=e.ref.controls.getGamepad(m),L=Math.abs(k)>.5,B=ae[v];L?g|=v:g&=~v,a.inputs[B]!==L&&L&&b.call("input",B,m),a.inputs[B]=L}}s=g;const w=e.ref.controls.ref.gamepad.meta,h=l.buttons[w.toggleUI].pressed,y=a.meta.toggleUI,_=l.buttons[w.save].pressed,A=a.meta.save,x=l.buttons[w.loadLastSave].pressed,T=a.meta.loadLastSave;h&&!y&&b.call("toggleUI"),_&&!A&&b.call("saveState"),x&&!T&&b.call("loadLastSave"),a.meta.toggleUI=h,a.meta.save=_,a.meta.loadLastSave=x}}function p(){u();const l=n|s;b.call("setJoypad1",l)}function c(l){r=l.gamepad.index}function f(l){l.gamepad.index===r&&(r=-1)}return{onKeyDown:i,onKeyUp:d,onGamepadConnected:c,onGamepadDisconnected:f,tick:p}};function Be(e,t,r){const n=e.getContext("webgl");if(n==null)throw new Error("Unable to get WebGL context. Your browser may not support it.");const s=n.createTexture();if(s==null)throw new Error("Unable to create texture.");n.bindTexture(n.TEXTURE_2D,s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);const a=n.createBuffer();if(a==null)throw new Error("Unable to create buffer.");n.bindBuffer(n.ARRAY_BUFFER,a),n.bufferData(n.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),n.STATIC_DRAW);const o=`
        attribute vec2 a_position;
        varying vec2 v_texCoord;

        void main() {
            gl_Position = vec4(a_position, 0, 1);
            v_texCoord = a_position * vec2(0.5, -0.5) + 0.5;
        }
    `,i=`
        precision mediump float;
        uniform sampler2D u_image;
        varying vec2 v_texCoord;

        void main() {
            gl_FragColor = texture2D(u_image, v_texCoord);
        }
    `,d=f(n.VERTEX_SHADER,o),u=f(n.FRAGMENT_SHADER,i),p=l(d,u),c=n.getAttribLocation(p,"a_position");n.viewport(0,0,t,r);function f(w,h){const y=n.createShader(w);if(!y)throw new Error("Unable to create shader.");if(n.shaderSource(y,h),n.compileShader(y),!n.getShaderParameter(y,n.COMPILE_STATUS))throw`Could not compile WebGL shader. 

`+n.getShaderInfoLog(y);return y}function l(w,h){const y=n.createProgram();if(!y)throw new Error("Unable to create program.");if(n.attachShader(y,w),n.attachShader(y,h),n.linkProgram(y),!n.getProgramParameter(y,n.LINK_STATUS))throw`Could not compile WebGL program. 

`+n.getProgramInfoLog(y);return y}function g(w){n.useProgram(p),n.enableVertexAttribArray(c),n.bindBuffer(n.ARRAY_BUFFER,a),n.vertexAttribPointer(c,2,n.FLOAT,!1,0,0),n.bindTexture(n.TEXTURE_2D,s),n.texImage2D(n.TEXTURE_2D,0,n.RGB,e.width,e.height,0,n.RGB,n.UNSIGNED_BYTE,w),n.drawArrays(n.TRIANGLES,0,6)}return{render:g}}const Ne=()=>{let e=0;const t=new Map,r={saved:[],uiToggled:[]};return{emit:(o,i)=>{r[o].forEach(({handler:d})=>d(i))},on:(o,i)=>(e+=1,r[o].push({id:e,handler:i}),t.set(e,o),e),remove:o=>{const i=t.get(o);if(i!=null){t.delete(o);const d=r[i].findIndex(u=>u.id===o);d!==-1&&r[i].splice(d,1)}}}},ee=Ne(),Ge=()=>[],z=e=>e,ue="nessy.store",be=2,de=()=>({version:be,rom:z(null),controls:_e(),scalingFactor:z(4),scalingMode:z("pixelated"),lastState:z(null)}),oe={serialize(e){return Array.from(e).map(t=>String.fromCharCode(t)).join("")},deserialize(e){return Uint8Array.from(e.split("").map(t=>t.charCodeAt(0)))},async hash(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(r=>r.toString(16).padStart(2,"0")).join("")}},je=async()=>{const e=await new Promise((c,f)=>{const l=indexedDB.open("nessy",1);l.onerror=f,l.onupgradeneeded=()=>{const g=l.result,w=g.createObjectStore("roms",{keyPath:"hash"});w.createIndex("hash","hash",{unique:!0}),w.createIndex("name","name",{unique:!1}),w.createIndex("data","data",{unique:!1});const h=g.createObjectStore("saves",{keyPath:"timestamp"});h.createIndex("timestamp","timestamp",{unique:!0}),h.createIndex("romHash","romHash",{unique:!1}),h.createIndex("state","state",{unique:!1});const y=g.createObjectStore("titleScreens",{keyPath:"romHash"});y.createIndex("romHash","romHash",{unique:!0}),y.createIndex("data","data",{unique:!1})},l.onsuccess=()=>{c(l.result)}});async function t(c,f){const l={hash:await oe.hash(f),name:c.endsWith(".nes")?c.slice(0,-4):c,data:f},h=e.transaction(["roms"],"readwrite").objectStore("roms").put(l);return new Promise((y,_)=>{h.onerror=_,h.onsuccess=()=>{y(l.hash)}})}async function r(c){return new Promise((f,l)=>{const h=e.transaction(["roms"],"readonly").objectStore("roms").get(c);h.onerror=l,h.onsuccess=()=>{h.result==null?l(new Error(`ROM with hash ${c} not found`)):f(h.result)}})}async function n(){return new Promise((c,f)=>{const w=e.transaction(["roms"],"readonly").objectStore("roms").getAll();w.onerror=()=>{c([])},w.onsuccess=()=>{c(w.result)}})}async function s(c,f){return new Promise((l,g)=>{const w={timestamp:Date.now(),romHash:c,state:f},_=e.transaction(["saves"],"readwrite").objectStore("saves").put(w);_.onerror=g,_.onsuccess=()=>{l(w.timestamp)}})}async function a(c){return new Promise((f,l)=>{const h=e.transaction(["saves"],"readonly").objectStore("saves").get(c);h.onerror=l,h.onsuccess=()=>{h.result==null?l(new Error(`Save with timestamp ${c} not found`)):f(h.result)}})}async function o(c){return new Promise((f,l)=>{const y=e.transaction(["saves"],"readonly").objectStore("saves").index("romHash").openCursor(IDBKeyRange.only(c),"prev");y.onerror=l,y.onsuccess=()=>{y.result==null?f(null):f(y.result.value)}})}async function i(c){return new Promise((f,l)=>{const y=e.transaction(["saves"],"readonly").objectStore("saves").index("romHash").getAll(c);y.onerror=()=>{f([])},y.onsuccess=()=>{f(y.result)}})}async function d(c,f){return new Promise((l,g)=>{const w={romHash:c,data:f},_=e.transaction(["titleScreens"],"readwrite").objectStore("titleScreens").put(w);_.onerror=g,_.onsuccess=()=>{l()}})}async function u(c){return new Promise((f,l)=>{const h=e.transaction(["titleScreens"],"readonly").objectStore("titleScreens").get(c);h.onerror=l,h.onsuccess=()=>{h.result==null?f(null):f(h.result)}})}async function p(){return new Promise((c,f)=>{const w=e.transaction(["titleScreens"],"readonly").objectStore("titleScreens").getAll();w.onerror=()=>{c([])},w.onsuccess=()=>{c(w.result)}})}return{rom:{get:r,insert:t,list:n},save:{get:a,getLast:o,insert:s,list:i},titleScreen:{get:u,insert:d,list:p}}},He=async()=>{const e=await je(),t=u=>JSON.stringify({...u,controls:u.controls.ref,lastState:u.lastState!=null?oe.serialize(u.lastState):null}),r=u=>{let p=JSON.parse(u);if("version"in p&&p.version!==be)p=de();else{const c=_e();c.update(p.controls),p.controls=c,p.lastState=p.lastState!=null?oe.deserialize(p.lastState):null}return p},n=(()=>{const u=localStorage.getItem(ue);return u!=null?r(u):de()})(),s=Ge();return{ref:n,subscribe:(u,p)=>{s.push({key:u,handler:p})},get:u=>n[u],set:(u,p)=>{const c=n[u];n[u]=p,s.forEach(({key:f,handler:l})=>{f===u&&l(p,c)})},save:()=>{localStorage.setItem(ue,t(n))},db:e}},C=32,We=e=>{let t=0;function r(s){e=s,t=Math.floor((C-s.width)/2),n.height=s.height}const n={state:{},width:C,height:e.height,render(s,a,o){e.render(s+t,a,o)},update:r};return r(e),n},qe=new Uint8Array([0,0,0,0,0,0,0,0,126,129,165,129,157,185,129,126,126,255,219,255,227,199,255,126,108,254,254,254,124,56,16,0,16,56,124,254,124,56,16,0,56,124,56,254,254,16,16,124,0,24,60,126,255,126,24,126,0,0,24,60,60,24,0,0,255,255,231,195,195,231,255,255,0,60,102,66,66,102,60,0,255,195,153,189,189,153,195,255,15,7,15,125,204,204,204,120,60,102,102,102,60,24,126,24,63,51,63,48,48,112,240,224,127,99,127,99,99,103,230,192,153,90,60,231,231,60,90,153,128,224,248,254,248,224,128,0,2,14,62,254,62,14,2,0,24,60,126,24,24,126,60,24,102,102,102,102,102,0,102,0,127,219,219,123,27,27,27,0,63,96,124,102,102,62,6,252,0,0,0,0,126,126,126,0,24,60,126,24,126,60,24,255,24,60,126,24,24,24,24,0,24,24,24,24,126,60,24,0,0,24,12,254,12,24,0,0,0,48,96,254,96,48,0,0,0,0,192,192,192,254,0,0,0,36,102,255,102,36,0,0,0,24,60,126,255,255,0,0,0,255,255,126,60,24,0,0,0,0,0,0,0,0,0,0,24,24,24,24,24,0,24,0,108,108,108,0,0,0,0,0,108,108,254,108,254,108,108,0,24,126,192,124,6,252,24,0,0,198,204,24,48,102,198,0,56,108,56,118,220,204,118,0,48,48,96,0,0,0,0,0,12,24,48,48,48,24,12,0,48,24,12,12,12,24,48,0,0,102,60,255,60,102,0,0,0,24,24,126,24,24,0,0,0,0,0,0,0,24,24,48,0,0,0,126,0,0,0,0,0,0,0,0,0,24,24,0,6,12,24,48,96,192,128,0,124,206,222,246,230,198,124,0,24,56,24,24,24,24,126,0,124,198,6,124,192,192,254,0,252,6,6,60,6,6,252,0,12,204,204,204,254,12,12,0,254,192,252,6,6,198,124,0,124,192,192,252,198,198,124,0,254,6,6,12,24,48,48,0,124,198,198,124,198,198,124,0,124,198,198,126,6,6,124,0,0,24,24,0,0,24,24,0,0,24,24,0,0,24,24,48,12,24,48,96,48,24,12,0,0,0,126,0,126,0,0,0,48,24,12,6,12,24,48,0,60,102,12,24,24,0,24,0,124,198,222,222,222,192,126,0,56,108,198,198,254,198,198,0,252,198,198,252,198,198,252,0,124,198,192,192,192,198,124,0,248,204,198,198,198,204,248,0,254,192,192,248,192,192,254,0,254,192,192,248,192,192,192,0,124,198,192,192,206,198,124,0,198,198,198,254,198,198,198,0,126,24,24,24,24,24,126,0,6,6,6,6,6,198,124,0,198,204,216,240,216,204,198,0,192,192,192,192,192,192,254,0,198,238,254,254,214,198,198,0,198,230,246,222,206,198,198,0,124,198,198,198,198,198,124,0,252,198,198,252,192,192,192,0,124,198,198,198,214,222,124,6,252,198,198,252,216,204,198,0,124,198,192,124,6,198,124,0,255,24,24,24,24,24,24,0,198,198,198,198,198,198,254,0,198,198,198,198,198,124,56,0,198,198,198,198,214,254,108,0,198,198,108,56,108,198,198,0,198,198,198,124,24,48,224,0,254,6,12,24,48,96,254,0,60,48,48,48,48,48,60,0,192,96,48,24,12,6,2,0,60,12,12,12,12,12,60,0,16,56,108,198,0,0,0,0,0,0,0,0,0,0,0,255,24,24,12,0,0,0,0,0,0,0,124,6,126,198,126,0,192,192,192,252,198,198,252,0,0,0,124,198,192,198,124,0,6,6,6,126,198,198,126,0,0,0,124,198,254,192,124,0,28,54,48,120,48,48,120,0,0,0,126,198,198,126,6,252,192,192,252,198,198,198,198,0,24,0,56,24,24,24,60,0,6,0,6,6,6,6,198,124,192,192,204,216,248,204,198,0,56,24,24,24,24,24,60,0,0,0,204,254,254,214,214,0,0,0,252,198,198,198,198,0,0,0,124,198,198,198,124,0,0,0,252,198,198,252,192,192,0,0,126,198,198,126,6,6,0,0,252,198,192,192,192,0,0,0,126,192,124,6,252,0,24,24,126,24,24,24,14,0,0,0,198,198,198,198,126,0,0,0,198,198,198,124,56,0,0,0,198,198,214,254,108,0,0,0,198,108,56,108,198,0,0,0,198,198,198,126,6,252,0,0,254,12,56,96,254,0,14,24,24,112,24,24,14,0,24,24,24,0,24,24,24,0,112,24,24,14,24,24,112,0,118,220,0,0,0,0,0,0,0,16,56,108,198,198,254,0,124,198,192,192,192,214,124,48,198,0,198,198,198,198,126,0,14,0,124,198,254,192,124,0,126,129,60,6,126,198,126,0,102,0,124,6,126,198,126,0,224,0,124,6,126,198,126,0,24,24,124,6,126,198,126,0,0,0,124,198,192,214,124,48,126,129,124,198,254,192,124,0,102,0,124,198,254,192,124,0,224,0,124,198,254,192,124,0,102,0,56,24,24,24,60,0,124,130,56,24,24,24,60,0,112,0,56,24,24,24,60,0,198,16,124,198,254,198,198,0,56,56,0,124,198,254,198,0,14,0,254,192,248,192,254,0,0,0,127,12,127,204,127,0,63,108,204,255,204,204,207,0,124,130,124,198,198,198,124,0,102,0,124,198,198,198,124,0,224,0,124,198,198,198,124,0,124,130,0,198,198,198,126,0,224,0,198,198,198,198,126,0,102,0,102,102,102,62,6,124,198,124,198,198,198,198,124,0,198,0,198,198,198,198,254,0,24,24,126,216,216,216,126,24,56,108,96,240,96,102,252,0,102,102,60,24,126,24,126,24,248,204,204,250,198,207,198,195,14,27,24,60,24,24,216,112,14,0,124,6,126,198,126,0,28,0,56,24,24,24,60,0,14,0,124,198,198,198,124,0,14,0,198,198,198,198,126,0,0,254,0,252,198,198,198,0,254,0,198,230,246,222,206,0,60,108,108,62,0,126,0,0,60,102,102,60,0,126,0,0,24,0,24,24,48,102,60,0,0,0,0,252,192,192,0,0,0,0,0,252,12,12,0,0,198,204,216,63,99,207,140,15,195,198,204,219,55,109,207,3,24,0,24,24,24,24,24,0,0,51,102,204,102,51,0,0,0,204,102,51,102,204,0,0,34,136,34,136,34,136,34,136,85,170,85,170,85,170,85,170,221,119,221,119,221,119,221,119,24,24,24,24,24,24,24,24,24,24,24,24,248,24,24,24,24,24,248,24,248,24,24,24,54,54,54,54,246,54,54,54,0,0,0,0,254,54,54,54,0,0,248,24,248,24,24,24,54,54,246,6,246,54,54,54,54,54,54,54,54,54,54,54,0,0,254,6,246,54,54,54,54,54,246,6,254,0,0,0,54,54,54,54,254,0,0,0,24,24,248,24,248,0,0,0,0,0,0,0,248,24,24,24,24,24,24,24,31,0,0,0,24,24,24,24,255,0,0,0,0,0,0,0,255,24,24,24,24,24,24,24,31,24,24,24,0,0,0,0,255,0,0,0,24,24,24,24,255,24,24,24,24,24,31,24,31,24,24,24,54,54,54,54,55,54,54,54,54,54,55,48,63,0,0,0,0,0,63,48,55,54,54,54,54,54,247,0,255,0,0,0,0,0,255,0,247,54,54,54,54,54,55,48,55,54,54,54,0,0,255,0,255,0,0,0,54,54,247,0,247,54,54,54,24,24,255,0,255,0,0,0,54,54,54,54,255,0,0,0,0,0,255,0,255,24,24,24,0,0,0,0,255,54,54,54,54,54,54,54,63,0,0,0,24,24,31,24,31,0,0,0,0,0,31,24,31,24,24,24,0,0,0,0,63,54,54,54,54,54,54,54,255,54,54,54,24,24,255,24,255,24,24,24,24,24,24,24,248,0,0,0,0,0,0,0,31,24,24,24,255,255,255,255,255,255,255,255,0,0,0,0,255,255,255,255,240,240,240,240,240,240,240,240,15,15,15,15,15,15,15,15,255,255,255,255,0,0,0,0,0,0,118,220,200,220,118,0,56,108,108,120,108,102,108,96,0,254,198,192,192,192,192,0,0,0,254,108,108,108,108,0,254,96,48,24,48,96,254,0,0,0,126,216,216,216,112,0,0,102,102,102,102,124,96,192,0,118,220,24,24,24,24,0,126,24,60,102,102,60,24,126,60,102,195,255,195,102,60,0,60,102,195,195,102,102,231,0,14,24,12,126,198,198,124,0,0,0,126,219,219,126,0,0,6,12,126,219,219,126,96,192,56,96,192,248,192,96,56,0,120,204,204,204,204,204,204,0,0,126,0,126,0,126,0,0,24,24,126,24,24,0,126,0,96,48,24,48,96,0,252,0,24,48,96,48,24,0,252,0,14,27,27,24,24,24,24,24,24,24,24,24,24,216,216,112,24,24,0,126,0,24,24,0,0,118,220,0,118,220,0,0,56,108,108,56,0,0,0,0,0,0,0,24,24,0,0,0,0,0,0,0,24,0,0,0,15,12,12,12,236,108,60,28,120,108,108,108,108,0,0,0,124,12,124,96,124,0,0,0,0,0,60,60,60,60,0,0,0,16,0,0,0,0,0,0]);function Ke(e,t=63,r=48){const s=(e.charCodeAt(0)&255)*8,a=qe.slice(s,s+8),o=new Uint8Array(64);for(let i=0;i<8;i++){const d=a[i];for(let u=0;u<8;u++)o[i*8+u]=d&1<<7-u?t:r}return o}function Y(e,t,r,n,s=48,a=0){for(let o=0;o<r.length;o++)n.setTile(e+o,t,Ke(r[o],s,a))}const fe={textColor:48,bgColor:0,maxLength:1/0},pe=(e,t)=>e.length>t?e.slice(0,t-3)+"...":e,R=(e,t=fe)=>{const r={active:!1},n={...fe,...t};e=pe(e,n.maxLength);const s={state:r,width:e.length,height:1,update(a){a!==e&&(s.width=a.length,e=pe(a,n.maxLength??1/0))},render:(a,o,i)=>{r.active?Y(a,o,e,i,n.bgColor,n.textColor):Y(a,o,e,i,n.textColor,n.bgColor)}};return s},$e=(e,t)=>{let r,n=!1;switch(e){case I.UP:r="up";break;case I.LEFT:r="left";break;case I.DOWN:r="down";break;case I.RIGHT:r="right";break;case I.A:r="a";break;case I.B:r="b";break;case I.START:r="start";break;case I.SELECT:r="select";break}const s=()=>{const o=`${I[e].padEnd(6," ")}`;if(n)return`${o} > ...`;let i=t.ref.controls.ref.keyboard.inputs[r];return i===" "&&(i="space"),`${o} > ${i.toUpperCase()}`},a=R(s());return{...a,render(o,i,d){a.update(s()),a.render(o,i,d)},onKeyDown(o){return n?(t.ref.controls.setKeyboard(o,r),n=!1,a.update(s()),!0):o==="Enter"?(n=!0,!0):!1}}},Xe=(e,t={spacing:1,align:"start",firstIndex:0,lastIndex:e.length-1})=>{const r={...t};let n=0,s=0;for(const a of e)n=Math.max(n,a.width),s+=a.height+r.spacing;return{state:r,width:n,height:s,render(a,o,i){let d=o;for(let u=r.firstIndex;u<=r.lastIndex;u++){const p=e[u];let c;switch(r.align){case"start":c=0;break;case"center":c=(n-p.width)/2;break;case"end":c=n-p.width;break}p.render(c+a,d,i),d+=p.height+r.spacing}},update(a){e=a,r.firstIndex=0,r.lastIndex=e.length-1}}},te=(e,{visibleItems:t=e.length,onSelect:r}={})=>{const n={activeIndex:0,items:e},s=Xe(e);e[0].state.active=!0;const a=i=>{e[n.activeIndex].state.active=!1,n.activeIndex=i,e[i].state.active=!0,r==null||r(i)},o=()=>{const i=s.state;n.activeIndex<i.firstIndex&&(i.firstIndex=Math.max(n.activeIndex,0),i.lastIndex=Math.min(i.firstIndex+t-1,e.length-1)),n.activeIndex>i.lastIndex&&(i.firstIndex=Math.max(n.activeIndex-t+1,0),i.lastIndex=Math.min(n.activeIndex,e.length-1))};return o(),{...s,state:n,next(){a((n.activeIndex+1)%e.length),o()},prev(){a(Math.max(n.activeIndex===0?e.length-1:n.activeIndex-1,0)),o()},update(i){s.update(i),e=i,n.items=i,n.activeIndex=0,s.state.firstIndex=0,s.state.lastIndex=Math.min(t,i.length)-1}}},Ve=e=>{const t=[I.UP,I.LEFT,I.DOWN,I.RIGHT,I.A,I.B,I.START,I.SELECT].map(a=>$e(a,e)),r=te(t);return{...r,onKeyDown:a=>t[r.state.activeIndex].onKeyDown(a),setActive:a=>{}}},Ye=(e,{initialIndex:t=0,onSelect:r}={})=>{const n={active:!0,activeIndex:t};e[t].state.active=!0;const s=[];let a=0,o=0;for(let d=0;d<e.length;d++){const u=e[d];s.push(Math.round(o+u.width/2)),o+=u.width+1,a=Math.max(a,u.width)}const i=d=>{d!==n.activeIndex&&(e[n.activeIndex].state.active=!1,e[d].state.active=!0,n.activeIndex=d,r==null||r(d))};return i(t),{state:n,width:C,height:1,render(d,u,p){let c=C/2-s[n.activeIndex];for(let f=0;f<e.length;f++){const l=e[f];l.render(c,u,p),c+=l.width+1}n.activeIndex>0&&Y(0,u,"< ",p),n.activeIndex<e.length-1&&Y(C-2,u," >",p)},next(){i(Math.min(n.activeIndex+1,e.length-1))},prev(){i(Math.max(n.activeIndex-1,0))}}},ie=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{}catch{return!1}return"showOpenFilePicker"in self})(),ze=ie?Promise.resolve().then(function(){return et}):Promise.resolve().then(function(){return ot});async function Ze(...e){return(await ze).default(...e)}ie?Promise.resolve().then(function(){return nt}):Promise.resolve().then(function(){return ct});ie?Promise.resolve().then(function(){return at}):Promise.resolve().then(function(){return ut});const Qe=async e=>{const t=await e.getFile();return t.handle=e,t};var Je=async(e=[{}])=>{Array.isArray(e)||(e=[e]);const t=[];e.forEach((s,a)=>{t[a]={description:s.description||"Files",accept:{}},s.mimeTypes?s.mimeTypes.map(o=>{t[a].accept[o]=s.extensions||[]}):t[a].accept["*/*"]=s.extensions||[]});const r=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),n=await Promise.all(r.map(Qe));return e[0].multiple?n:n[0]},et={__proto__:null,default:Je};function J(e){function t(r){if(Object(r)!==r)return Promise.reject(new TypeError(r+" is not an object."));var n=r.done;return Promise.resolve(r.value).then(function(s){return{value:s,done:n}})}return J=function(r){this.s=r,this.n=r.next},J.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(r){var n=this.s.return;return n===void 0?Promise.resolve({value:r,done:!0}):t(n.apply(this.s,arguments))},throw:function(r){var n=this.s.return;return n===void 0?Promise.reject(r):t(n.apply(this.s,arguments))}},new J(e)}const ve=async(e,t,r=e.name,n)=>{const s=[],a=[];var o,i=!1,d=!1;try{for(var u,p=function(c){var f,l,g,w=2;for(typeof Symbol<"u"&&(l=Symbol.asyncIterator,g=Symbol.iterator);w--;){if(l&&(f=c[l])!=null)return f.call(c);if(g&&(f=c[g])!=null)return new J(f.call(c));l="@@asyncIterator",g="@@iterator"}throw new TypeError("Object is not async iterable")}(e.values());i=!(u=await p.next()).done;i=!1){const c=u.value,f=`${r}/${c.name}`;c.kind==="file"?a.push(c.getFile().then(l=>(l.directoryHandle=e,l.handle=c,Object.defineProperty(l,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>f})))):c.kind!=="directory"||!t||n&&n(c)||s.push(ve(c,t,f,n))}}catch(c){d=!0,o=c}finally{try{i&&p.return!=null&&await p.return()}finally{if(d)throw o}}return[...(await Promise.all(s)).flat(),...await Promise.all(a)]};var tt=async(e={})=>{e.recursive=e.recursive||!1,e.mode=e.mode||"read";const t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn,mode:e.mode});return(await(await t.values()).next()).done?[t]:ve(t,e.recursive,void 0,e.skipDirectory)},nt={__proto__:null,default:tt},rt=async(e,t=[{}],r=null,n=!1,s=null)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";const a=[];let o=null;if(e instanceof Blob&&e.type?o=e.type:e.headers&&e.headers.get("content-type")&&(o=e.headers.get("content-type")),t.forEach((u,p)=>{a[p]={description:u.description||"Files",accept:{}},u.mimeTypes?(p===0&&o&&u.mimeTypes.push(o),u.mimeTypes.map(c=>{a[p].accept[c]=u.extensions||[]})):o?a[p].accept[o]=u.extensions||[]:a[p].accept["*/*"]=u.extensions||[]}),r)try{await r.getFile()}catch(u){if(r=null,n)throw u}const i=r||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:a,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1});!r&&s&&s(i);const d=await i.createWritable();return"stream"in e?(await e.stream().pipeTo(d),i):"body"in e?(await e.body.pipeTo(d),i):(await d.write(await e),await d.close(),i)},at={__proto__:null,default:rt},st=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,r)=>{const n=document.createElement("input");n.type="file";const s=[...e.map(d=>d.mimeTypes||[]),...e.map(d=>d.extensions||[])].join();n.multiple=e[0].multiple||!1,n.accept=s||"",n.style.display="none",document.body.append(n);const a=d=>{typeof o=="function"&&o(),t(d)},o=e[0].legacySetup&&e[0].legacySetup(a,()=>o(r),n),i=()=>{window.removeEventListener("focus",i),n.remove()};n.addEventListener("click",()=>{window.addEventListener("focus",i)}),n.addEventListener("change",()=>{window.removeEventListener("focus",i),n.remove(),a(n.multiple?Array.from(n.files):n.files[0])}),"showPicker"in HTMLInputElement.prototype?n.showPicker():n.click()})),ot={__proto__:null,default:st},it=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,r)=>{const n=document.createElement("input");n.type="file",n.webkitdirectory=!0;const s=o=>{typeof a=="function"&&a(),t(o)},a=e[0].legacySetup&&e[0].legacySetup(s,()=>a(r),n);n.addEventListener("change",()=>{let o=Array.from(n.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(o=o.filter(i=>i.webkitRelativePath.split("/").every(d=>!e[0].skipDirectory({name:d,kind:"directory"})))):o=o.filter(i=>i.webkitRelativePath.split("/").length===2),s(o)}),"showPicker"in HTMLInputElement.prototype?n.showPicker():n.click()})),ct={__proto__:null,default:it},lt=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);const r=document.createElement("a");let n=e;"body"in e&&(n=await async function(o,i){const d=o.getReader(),u=new ReadableStream({start:f=>async function l(){return d.read().then(({done:g,value:w})=>{if(!g)return f.enqueue(w),l();f.close()})}()}),p=new Response(u),c=await p.blob();return d.releaseLock(),new Blob([c],{type:i})}(e.body,e.headers.get("content-type"))),r.download=t.fileName||"Untitled",r.href=URL.createObjectURL(await n);const s=()=>{typeof a=="function"&&a()},a=t.legacySetup&&t.legacySetup(s,()=>a(),r);return r.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(r.href),3e4),s()}),r.click(),null},ut={__proto__:null,default:lt};const F=(e,t)=>({...e,enter(){t()}}),me=22,dt=e=>{const t=[F(R("Load ROMs..."),s)],r=te(t,{visibleItems:8,onSelect:d});r.width=me;let n=[];async function s(){try{const c=await Ze({description:"NES ROM file",extensions:[".nes"],mimeTypes:["application/octet-stream"],multiple:!0});let f=0;const l=()=>`Title Screens [${f}/${c.length}]`,g=R(l());r.update(t.concat(F(g,()=>{})));for(const w of c){try{const h=new Uint8Array(await w.arrayBuffer()),y=await e.db.rom.insert(w.name,h);c.length===1&&e.set("rom",y),await b.call("generateTitleScreen",y)}catch(h){console.error(`Failed to load file ${w.name}: ${h}`)}f+=1,g.update(l())}await o()}catch(c){console.error(c)}}function a(c){e.set("rom",c.hash)}async function o(){n=(await e.db.rom.list()).sort((c,f)=>c.name.localeCompare(f.name)),r.update(t.concat(n.map(c=>F(R(c.name,{maxLength:me}),()=>a(c)))))}function i(){const c=r.state.activeIndex;if(c>=t.length){const f=n[c-t.length].hash;b.call("setBackground",{mode:"titleScreen",hash:f})}else b.call("setBackground",{mode:"current"})}function d(){i()}o();function u(c){return c==="start"||c==="a"?(r.state.items[r.state.activeIndex].enter(),!0):!1}function p(c){c?i():b.call("setBackground",{mode:"current"})}return{...r,onAction:u,setActive:p}},Se=({name:e,options:t,onChange:r,initialOption:n=t[0],text:s})=>{const a=R(e,s);let o;const i=d=>{o=d,a.update(e+": "+t[o]),r(t[d],d)};return i(t.indexOf(n)),{...a,onAction(d){if(a.state.active)switch(d){case"select":return i(o===0?t.length-1:o-1),!0;case"start":case"a":return i((o+1)%t.length),!0}return!1}}},ft=e=>{const t={"1x":1,"2x":2,"3x":3,"4x":4,max:50};return Se({name:"Zoom",options:["1x","2x","3x","4x","max"],initialOption:{1:"1x",2:"2x",3:"3x",4:"4x",50:"max"}[e.ref.scalingFactor],onChange:n=>e.set("scalingFactor",t[n])})},pt=e=>Se({name:"Rendering",options:["pixelated","blurry"],initialOption:e.ref.scalingMode,onChange:t=>e.set("scalingMode",t)}),mt=()=>({...F(R("Toggle Fullscreen"),()=>b.call("toggleFullscreen")),onAction(e){return e==="start"||e==="a"?(this.enter(),!0):!1}}),gt=()=>({...F(R("Soft Reset (CTRL+R)"),()=>{b.call("softReset"),b.call("toggleUI",!1)}),onAction(e){return e==="start"||e==="a"?(this.enter(),!0):!1}}),wt=e=>{const t=te([ft(e),pt(e),mt(),gt()]);return{...t,onAction:s=>t.state.items[t.state.activeIndex].onAction(s),setActive:s=>{}}},ht=0,yt=1,_t=e=>{const t=[F(R("Save (CTRL+S)"),()=>b.call("saveState")),F(R("Load last (CTRL+L)"),()=>b.call("loadLastSave"))],r=te(t,{visibleItems:8,onSelect:o});r.width=19;let n=[];const s=async()=>{e.ref.rom==null?r.update(t):(n=(await e.db.save.list(e.ref.rom)).sort((u,p)=>p.timestamp-u.timestamp),r.update(t.concat(n.map(u=>{const p=new Date(u.timestamp);return F(R(`${p.toLocaleDateString()} ${p.toLocaleTimeString()}`),()=>b.call("loadSave",u.timestamp))}))))};async function a(){const u=r.state.activeIndex;switch(u){case ht:b.call("setBackground",{mode:"current"});break;case yt:if(e.ref.rom!=null){const c=await e.db.save.getLast(e.ref.rom);c!=null&&b.call("setBackground",{mode:"at",timestamp:c.timestamp})}break;default:const{timestamp:p}=n[u-t.length];b.call("setBackground",{mode:"at",timestamp:p});break}}async function o(){await a()}return s(),e.subscribe("rom",s),ee.on("saved",s),{...r,onAction:u=>u==="start"||u==="a"?(r.state.items[r.state.activeIndex].enter(),!0):!1,setActive:u=>{u?a():b.call("setBackground",{mode:"current"})}}},bt=[[0,0,0],[0,61,166],[0,18,176],[68,0,150],[161,0,94],[199,0,40],[186,6,0],[140,23,0],[92,47,0],[16,69,0],[5,74,0],[0,71,46],[0,65,102],[0,0,0],[5,5,5],[5,5,5],[199,199,199],[0,119,255],[33,85,255],[130,55,250],[235,47,181],[255,41,80],[255,34,0],[214,50,0],[196,98,0],[53,128,0],[5,143,0],[0,138,85],[0,153,204],[33,33,33],[9,9,9],[9,9,9],[255,255,255],[15,215,255],[105,162,255],[212,128,255],[255,69,243],[255,97,139],[255,136,51],[255,156,18],[250,188,32],[159,227,14],[43,240,53],[12,240,164],[5,251,255],[94,94,94],[13,13,13],[13,13,13],[255,255,255],[166,252,255],[179,236,255],[218,171,235],[255,168,249],[255,171,179],[255,210,176],[255,239,166],[255,247,156],[215,232,149],[166,237,175],[162,242,218],[153,255,252],[221,221,221],[17,17,17],[17,17,17]],G=32,Z=30,vt=(e,t)=>{const r=[],n=new Uint8Array(64).fill(0),s=new Uint8Array(e*t*3).fill(0);let a=0;for(let f=0;f<G*Z;f+=1)r.push(n);function o(f,l,g){f>=0&&f<G&&l>=0&&l<Z&&(r[f+l*G]=g)}function i(f,l){o(f,l,n)}function d(){for(let f=0;f<G*Z;f+=1)r[f]=n}function u(f,l=.2){s.set(f),a=l}function p(f,l){return Math.round(f*(1-a)+l*a)}function c(f){for(let l=0;l<Z;l+=1)for(let g=0;g<G;g+=1){const w=r[g+l*G];for(let h=0;h<8;h+=1)for(let y=0;y<8;y+=1){const _=w[y+h*8],A=bt[_],x=(g*8+y+(l*8+h)*e)*3;f[x+0]=p(A[0],s[x+0]),f[x+1]=p(A[1],s[x+1]),f[x+2]=p(A[2],s[x+2])}}}return{setTile:o,clearTile:i,clear:d,render:c,setBackground:u}},St={info:0,error:6},xt={info:48,error:48},At={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",Enter:"start"," ":"select"},It=(e,t,r)=>{const n=vt(t,r),s=[],a={library:dt(e),saves:_t(e),controls:Ve(e),"misc.":wt(e)},o=Object.keys(a),i=Ye(o.map(_=>R(_)),{initialIndex:0,onSelect:p}),d=We(a[o[i.state.activeIndex]]);let u=i.state.activeIndex;function p(_){a[o[u]].setActive(!1),a[o[_]].setActive(!0),u=_}ee.on("uiToggled",({visible:_})=>{a[o[i.state.activeIndex]].setActive(_),s.length=0});const c={render:h,screen:n,onAction:f,onKeyDown:g,onGamePad:l,alert:y,visible:!0};function f(_){var x,T;const A=o[i.state.activeIndex];if(_==="toggle_ui")return b.call("toggleUI"),!0;if(c.visible){if(((T=(x=a[A]).onAction)==null?void 0:T.call(x,_))??!1)return!0;switch(_){case"left":if(c.visible)return i.prev(),d.update(a[o[i.state.activeIndex]]),!0;break;case"right":if(c.visible)return i.next(),d.update(a[o[i.state.activeIndex]]),!0;break;case"down":if(c.visible)return a[A].next(),!0;break;case"up":if(c.visible)return a[A].prev(),!0;break}}return!1}function l(_){var A,x;if(c.visible){const T=o[i.state.activeIndex];(x=(A=a[T]).onGamePad)==null||x.call(A,_)}}function g(_){var A,x;if(c.visible){if((x=(A=a[o[i.state.activeIndex]]).onKeyDown)==null?void 0:x.call(A,_))return!0;const E=At[_];if(E)return f(E)}return!1}function w(){if(s.length>0){const _=s[0];if(_.frames>0){const A=xt[_.type],x=St[_.type],T=_.text.slice(0,C);Y(C-T.length,2,T,n,A,x),_.frames-=1}else s.shift()}}function h(_){n.clear(),i.render(0,6,n),d.render(0,9,n),w(),n.render(_)}function y(_){s.push(_)}return c},O=256*2,D=240,xe=0,Et=1,Ae=2,Tt={[xe]:1024,[Et]:512,[Ae]:1024},ge={pixelated:"pixelated",blurry:"auto"};async function Lt(){await ye(),H.initPanicHook();const e=await He(),t=It(e,O,D),r=xe,n=Tt[r],s=r===Ae,a=document.querySelector("#screen"),o=Be(a,O,D);let i;const d=Ce(e),u=new Uint8Array(O*D*3),p=new AudioContext,c=new Uint8Array(O*D*3);function f(m){try{return m()}catch(v){throw t.alert({text:`${v}`,type:"error",frames:2.5*60}),v}}a.width=O,a.height=D,a.style.imageRendering=ge[e.ref.scalingMode];function l(){const m=window.innerWidth,v=window.innerHeight,L=Math.min(m/O,v/D,e.ref.scalingFactor);a.style.width=`${O*L}px`,a.style.height=`${D*L}px`}l(),window.addEventListener("resize",l),e.subscribe("scalingFactor",l),e.subscribe("scalingMode",()=>{a.style.imageRendering=ge[e.ref.scalingMode]}),b.register("toggleUI",async m=>{m!==void 0?t.visible=m:t.visible=!t.visible,t.visible?(c.set(u),b.call("setBackground",{mode:"current"}),await p.suspend()):i!==void 0&&(i.clearAudioBuffer(),await p.resume()),ee.emit("uiToggled",{visible:t.visible})}),window.addEventListener("blur",()=>{t.visible||b.call("toggleUI")});const g=p.createScriptProcessor(n,0,1);g.onaudioprocess=(()=>m=>{if(!t.visible){const v=m.outputBuffer.getChannelData(0);i.fillAudioBuffer(v,s)}})(),g.connect(p.destination),b.register("input",(m,v)=>{v&&t.onAction(m)});const w=m=>{t.onKeyDown(m.key)?m.preventDefault():d==null||d.onKeyDown(m)},h=m=>{d==null||d.onKeyUp(m)};window.addEventListener("keydown",w),window.addEventListener("keyup",h),window.addEventListener("gamepadconnected",d.onGamepadConnected),window.addEventListener("gamepaddisconnected",d.onGamepadDisconnected);function y(m){i=H.new(m,p.sampleRate),u.fill(0)}async function _(m){if(m!=null)try{const v=await e.db.rom.get(m);return y(v.data),!0}catch(v){console.error("Could not load ROM:",v),t.alert({text:`${v}`,type:"error",frames:2.5*60}),e.set("rom",null)}return!1}e.subscribe("rom",async(m,v)=>{m!=null&&(m!==v?await _(m)&&b.call("toggleUI"):b.call("toggleUI"))}),b.register("loadSave",async m=>{const v=await e.db.save.get(m);f(()=>{i.loadState(v.state),b.call("toggleUI",!1)})}),b.register("loadLastSave",async()=>{const m=await e.db.save.getLast(e.ref.rom);m!=null&&f(()=>{i.loadState(m.state),b.call("toggleUI",!1)})}),b.register("saveState",async()=>{const m=i.saveState(),v=await e.db.save.insert(e.ref.rom,m);return ee.emit("saved",{timestamp:v}),m});function A(m,v){const L=i.saveState();i.loadState(m),i.nextFrame(),i.fillFrameBuffer(v),i.loadState(L)}b.register("setBackground",async m=>{switch(m.mode){case"current":{u.set(c);break}case"at":{const v=await e.db.save.get(m.timestamp);A(v.state,u);break}case"titleScreen":{if(e.ref.rom===m.hash)u.set(c);else{const v=await e.db.titleScreen.get(m.hash);v!=null?u.set(v.data):u.fill(0)}break}}t.screen.setBackground(u,.2),o.render(u)});async function x(){e.ref.rom!=null&&(await _(e.ref.rom),i&&e.ref.lastState!=null&&(i.loadState(e.ref.lastState),i.nextFrame(),i.fillFrameBuffer(c),i.loadState(e.ref.lastState),b.call("setBackground",{mode:"current"}))),k()}const T=new Uint8Array(O*D*3);b.register("generateTitleScreen",async m=>{try{const v=await e.db.rom.get(m),L=await e.db.titleScreen.get(m);if(L==null){const B=H.new(v.data,p.sampleRate);for(let ce=0;ce<120;ce++)B.nextFrame(),B.fillFrameBuffer(T);return await e.db.titleScreen.insert(m,T),T}else return L.data}catch(v){return console.error(`Failed to generate title screen for ${m}: ${v}`),T.fill(0),T}}),b.register("toggleFullscreen",()=>{document.fullscreenElement?document.exitFullscreen():a.requestFullscreen()}),b.register("softReset",()=>{i==null||i.softReset()}),b.register("setJoypad1",m=>{t.visible||i==null||i.setJoypad1(m)});function E(){i!=null&&(e.ref.lastState=i.saveState()),e.save()}function k(){requestAnimationFrame(k),d.tick(),t.visible?(t.render(u),o.render(u)):i!==void 0&&(i.nextFrame(),console.log(i.getUpdatedTilesCount()),i.fillFrameBuffer(u),o.render(u))}await x(),window.addEventListener("beforeunload",E)}window.addEventListener("DOMContentLoaded",Lt);
