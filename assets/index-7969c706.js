(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();let _;const me=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&me.decode();let H=null;function B(){return(H===null||H.byteLength===0)&&(H=new Uint8Array(_.memory.buffer)),H}function Q(e,t){return e=e>>>0,me.decode(B().subarray(e,e+t))}let T=0;const z=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},Se=typeof z.encodeInto=="function"?function(e,t){return z.encodeInto(e,t)}:function(e,t){const n=z.encode(e);return t.set(n),{read:e.length,written:n.length}};function xe(e,t,n){if(n===void 0){const i=z.encode(e),f=t(i.length,1)>>>0;return B().subarray(f,f+i.length).set(i),T=i.length,f}let r=e.length,s=t(r,1)>>>0;const a=B();let o=0;for(;o<r;o++){const i=e.charCodeAt(o);if(i>127)break;a[s+o]=i}if(o!==r){o!==0&&(e=e.slice(o)),s=n(s,r,r=o+e.length*3,1)>>>0;const i=B().subarray(s+o,s+r),f=Se(e,i);o+=f.written,s=n(s,r,o,1)>>>0}return T=o,s}let M=null;function ae(){return(M===null||M.buffer.detached===!0||M.buffer.detached===void 0&&M.buffer!==_.memory.buffer)&&(M=new DataView(_.memory.buffer)),M}function we(e,t){return e=e>>>0,B().subarray(e/1,e/1+t)}function K(e,t){const n=t(e.length*1,1)>>>0;return B().set(e,n/1),T=e.length,n}function se(e){const t=_.__wbindgen_export_3.get(e);return _.__externref_table_dealloc(e),t}let W=null;function Ae(){return(W===null||W.byteLength===0)&&(W=new Float32Array(_.memory.buffer)),W}function oe(e,t){const n=t(e.length*4,4)>>>0;return Ae().set(e,n/4),T=e.length,n}const ie=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>_.__wbg_nes_free(e>>>0,1));class G{static __wrap(t){t=t>>>0;const n=Object.create(G.prototype);return n.__wbg_ptr=t,ie.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,ie.unregister(this),t}free(){const t=this.__destroy_into_raw();_.__wbg_nes_free(t,0)}static initPanicHook(){_.nes_initPanicHook()}static new(t,n){const r=K(t,_.__wbindgen_malloc),s=T,a=_.nes_new(r,s,n);if(a[2])throw se(a[1]);return G.__wrap(a[0])}softReset(){_.nes_softReset(this.__wbg_ptr)}nextFrame(t){var n=K(t,_.__wbindgen_malloc),r=T;_.nes_nextFrame(this.__wbg_ptr,n,r,t)}nextSamples(t){var n=oe(t,_.__wbindgen_malloc),r=T;return _.nes_nextSamples(this.__wbg_ptr,n,r,t)!==0}fillFrameBuffer(t){var n=K(t,_.__wbindgen_malloc),r=T;_.nes_fillFrameBuffer(this.__wbg_ptr,n,r,t)}setJoypad1(t){_.nes_setJoypad1(this.__wbg_ptr,t)}setJoypad2(t){_.nes_setJoypad2(this.__wbg_ptr,t)}saveState(){const t=_.nes_saveState(this.__wbg_ptr);var n=we(t[0],t[1]).slice();return _.__wbindgen_free(t[0],t[1]*1,1),n}loadState(t){const n=K(t,_.__wbindgen_malloc),r=T,s=_.nes_loadState(this.__wbg_ptr,n,r);if(s[1])throw se(s[0])}fillAudioBuffer(t,n){var r=oe(t,_.__wbindgen_malloc),s=T;_.nes_fillAudioBuffer(this.__wbg_ptr,r,s,t,n)}clearAudioBuffer(){_.nes_clearAudioBuffer(this.__wbg_ptr)}}async function Ee(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function Ie(){const e={};return e.wbg={},e.wbg.__wbg_error_7534b8e9a36f1ab4=function(t,n){let r,s;try{r=t,s=n,console.error(Q(t,n))}finally{_.__wbindgen_free(r,s,1)}},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(t,n){const r=n.stack,s=xe(r,_.__wbindgen_malloc,_.__wbindgen_realloc),a=T;ae().setInt32(t+4*1,a,!0),ae().setInt32(t+4*0,s,!0)},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,r){new Uint8Array(r.buffer,r.byteOffset,r.byteLength).set(we(t,n))},e.wbg.__wbindgen_init_externref_table=function(){const t=_.__wbindgen_export_3,n=t.grow(4);t.set(0,void 0),t.set(n+0,void 0),t.set(n+1,null),t.set(n+2,!0),t.set(n+3,!1)},e.wbg.__wbindgen_string_new=function(t,n){return Q(t,n)},e.wbg.__wbindgen_throw=function(t,n){throw new Error(Q(t,n))},e}function Te(e,t){return _=e.exports,ye.__wbindgen_wasm_module=t,M=null,W=null,H=null,_.__wbindgen_start(),_}async function ye(e){if(_!==void 0)return _;typeof e<"u"&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e}=e:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof e>"u"&&(e=new URL("/nessy/wasm/nessy_web_bg.wasm",self.location));const t=Ie();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await Ee(await e,t);return Te(n,r)}const Le=()=>{const e={};return{register(t,n){if(e[t]!=null)throw new Error(`Hook ${String(t)} is already registered`);e[t]=n},call(t,...n){const r=e[t];if(r!=null)return r.apply(null,n);throw new Error(`Hook ${String(t)} is not registered`)}}},b=Le();var x=(e=>(e[e.A=1]="A",e[e.B=2]="B",e[e.SELECT=4]="SELECT",e[e.START=8]="START",e[e.UP=16]="UP",e[e.DOWN=32]="DOWN",e[e.LEFT=64]="LEFT",e[e.RIGHT=128]="RIGHT",e))(x||{});const D={up:16,left:64,down:32,right:128,b:2,a:1,start:8,select:4},J={16:"up",64:"left",32:"down",128:"right",2:"b",1:"a",8:"start",4:"select"},Re={inputs:{up:"w",left:"a",down:"s",right:"d",b:"k",a:"l",start:"Enter",select:" "},meta:{toggleUI:"Escape",save:"META+s",loadLastSave:"META+l"}},ke=17,Pe={inputs:{up:12,left:14,down:13,right:15,b:0,a:1,start:9,select:8},meta:{toggleUI:6,save:10,loadLastSave:11}},Ue={keyboard:Re,gamepad:Pe},be=(e=Ue)=>{const t={keyboard:{inputs:{},meta:{}},gamepad:{inputs:{},meta:{}}},n=()=>JSON.stringify(e),r=s=>{for(const[a,o]of Object.entries(s.keyboard.inputs))s.keyboard.inputs[a]=o,t.keyboard.inputs[o]=D[a];for(const[a,o]of Object.entries(s.keyboard.meta))s.keyboard.meta[a]=o,t.keyboard.meta[o]=D[a];for(const[a,o]of Object.entries(s.gamepad.inputs))s.gamepad.inputs[a]=o,t.gamepad.inputs[o]=D[a];for(const[a,o]of Object.entries(s.gamepad.meta))s.gamepad.meta[a]=o,t.gamepad.meta[o]=D[a]};return r(e),{ref:e,reversed:t,setKeyboard(s,a){delete t.keyboard.inputs[e.keyboard.inputs[a]],t.keyboard.inputs[s]=D[a],e.keyboard.inputs[a]=s},setGamepad(s,a){delete t.gamepad.inputs[e.gamepad.inputs[a]],t.gamepad.inputs[s]=D[a],e.gamepad.inputs[a]=s},getKeyboard(s){return t.keyboard.inputs[s]??null},getGamepad(s){return t.gamepad.inputs[s]??null},isKeyMapped(s){return s in t.keyboard.inputs},isInputMapped(s){return s in t.gamepad.inputs},serialize:n,update:r}},Me=e=>{let t=!1,n=-1,r=0,s=0;const a={inputs:{up:!1,left:!1,down:!1,right:!1,b:!1,a:!1,start:!1,select:!1},meta:{toggleUI:!1,save:!1,loadLastSave:!1}};async function o(u,y){if(u.key==="Meta"&&(t=y,u.preventDefault()),y&&(u.key==="Escape"||u.key==="Tab")?(u.preventDefault(),a.meta.toggleUI||(b.call("toggleUI"),a.meta.toggleUI=!0)):a.meta.toggleUI=!1,t&&y)switch(u.key){case"s":{if(u.preventDefault(),!a.meta.save){b.call("saveState"),a.meta.save=!0;return}break}case"r":{u.preventDefault(),b.call("softReset");return}case"l":{if(u.preventDefault(),!a.meta.loadLastSave){await b.call("loadLastSave"),a.meta.loadLastSave=!0;return}break}default:a.meta.save=!1,a.meta.loadLastSave=!1,u.preventDefault()}if(e.ref.controls.isKeyMapped(u.key)){(u.key==="Enter"||u.key===" ")&&u.preventDefault();const m=e.ref.controls.getKeyboard(u.key),p=J[m];y?r|=m:r&=~m,a.inputs[p]!==y&&(b.call("input",p),a.inputs[p]=y)}}const i=u=>o(u,!0),f=u=>o(u,!1);function l(){if(n>=0){const u=navigator.getGamepads()[n];let y=s;for(let A=0;A<16;A++){const R=u.buttons[A];if(e.ref.controls.isInputMapped(A)){const w=e.ref.controls.getGamepad(A),h=J[w];R.pressed?y|=w:y&=~w,a.inputs[h]!==R.pressed&&R.pressed&&b.call("input",h,A),a.inputs[h]=R.pressed}}for(let A=0;A<4;A++){const R=u.axes[A],w=ke+2*A+(R<0?0:1);if(e.ref.controls.isInputMapped(w)){const h=e.ref.controls.getGamepad(w),I=Math.abs(R)>.5,j=J[h];I?y|=h:y&=~h,a.inputs[j]!==I&&I&&b.call("input",j,w),a.inputs[j]=I}}s=y;const m=e.ref.controls.ref.gamepad.meta,p=u.buttons[m.toggleUI].pressed,v=a.meta.toggleUI,S=u.buttons[m.save].pressed,E=a.meta.save,k=u.buttons[m.loadLastSave].pressed,U=a.meta.loadLastSave;p&&!v&&b.call("toggleUI"),S&&!E&&b.call("saveState"),k&&!U&&b.call("loadLastSave"),a.meta.toggleUI=p,a.meta.save=S,a.meta.loadLastSave=k}}function d(){l();const u=r|s;b.call("setJoypad1",u)}function c(u){n=u.gamepad.index}function g(u){u.gamepad.index===n&&(n=-1)}return{onKeyDown:i,onKeyUp:f,onGamepadConnected:c,onGamepadDisconnected:g,tick:d}};function Oe(e){const t=e.getContext("webgl");if(t==null)throw new Error("Unable to get WebGL context. Your browser may not support it.");const n=t.createTexture();if(n==null)throw new Error("Unable to create texture.");t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const r=t.createBuffer();if(r==null)throw new Error("Unable to create buffer.");t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),t.STATIC_DRAW);const s=`
        attribute vec2 a_position;
        varying vec2 v_texCoord;

        void main() {
            gl_Position = vec4(a_position, 0, 1);
            v_texCoord = a_position * vec2(0.5, -0.5) + 0.5;
        }
    `,a=`
        precision mediump float;
        uniform sampler2D u_image;
        varying vec2 v_texCoord;

        void main() {
            gl_FragColor = texture2D(u_image, v_texCoord);
        }
    `,o=d(t.VERTEX_SHADER,s),i=d(t.FRAGMENT_SHADER,a),f=c(o,i),l=t.getAttribLocation(f,"a_position");t.viewport(0,0,256,240);function d(u,y){const m=t.createShader(u);if(!m)throw new Error("Unable to create shader.");if(t.shaderSource(m,y),t.compileShader(m),!t.getShaderParameter(m,t.COMPILE_STATUS))throw`Could not compile WebGL shader. 

`+t.getShaderInfoLog(m);return m}function c(u,y){const m=t.createProgram();if(!m)throw new Error("Unable to create program.");if(t.attachShader(m,u),t.attachShader(m,y),t.linkProgram(m),!t.getProgramParameter(m,t.LINK_STATUS))throw`Could not compile WebGL program. 

`+t.getProgramInfoLog(m);return m}function g(u){t.useProgram(f),t.enableVertexAttribArray(l),t.bindBuffer(t.ARRAY_BUFFER,r),t.vertexAttribPointer(l,2,t.FLOAT,!1,0,0),t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGB,e.width,e.height,0,t.RGB,t.UNSIGNED_BYTE,u),t.drawArrays(t.TRIANGLES,0,6)}return{render:g}}const De=()=>{let e=0;const t=new Map,n={saved:[],uiToggled:[]};return{emit:(o,i)=>{n[o].forEach(({handler:f})=>f(i))},on:(o,i)=>(e+=1,n[o].push({id:e,handler:i}),t.set(e,o),e),remove:o=>{const i=t.get(o);if(i!=null){t.delete(o);const f=n[i].findIndex(l=>l.id===o);f!==-1&&n[i].splice(f,1)}}}},Y=De(),Fe=()=>[],$=e=>e,ce="nessy.store",he=2,le=()=>({version:he,rom:$(null),controls:be(),scalingFactor:$(4),scalingMode:$("pixelated"),lastState:$(null)}),ee={serialize(e){return Array.from(e).map(t=>String.fromCharCode(t)).join("")},deserialize(e){return Uint8Array.from(e.split("").map(t=>t.charCodeAt(0)))},async hash(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(n=>n.toString(16).padStart(2,"0")).join("")}},Ce=async()=>{const e=await new Promise((c,g)=>{const u=indexedDB.open("nessy",1);u.onerror=g,u.onupgradeneeded=()=>{const y=u.result,m=y.createObjectStore("roms",{keyPath:"hash"});m.createIndex("hash","hash",{unique:!0}),m.createIndex("name","name",{unique:!1}),m.createIndex("data","data",{unique:!1});const p=y.createObjectStore("saves",{keyPath:"timestamp"});p.createIndex("timestamp","timestamp",{unique:!0}),p.createIndex("romHash","romHash",{unique:!1}),p.createIndex("state","state",{unique:!1});const v=y.createObjectStore("titleScreens",{keyPath:"romHash"});v.createIndex("romHash","romHash",{unique:!0}),v.createIndex("data","data",{unique:!1})},u.onsuccess=()=>{c(u.result)}});async function t(c,g){const u={hash:await ee.hash(g),name:c.endsWith(".nes")?c.slice(0,-4):c,data:g},p=e.transaction(["roms"],"readwrite").objectStore("roms").put(u);return new Promise((v,S)=>{p.onerror=S,p.onsuccess=()=>{v(u.hash)}})}async function n(c){return new Promise((g,u)=>{const p=e.transaction(["roms"],"readonly").objectStore("roms").get(c);p.onerror=u,p.onsuccess=()=>{p.result==null?u(new Error(`ROM with hash ${c} not found`)):g(p.result)}})}async function r(){return new Promise((c,g)=>{const m=e.transaction(["roms"],"readonly").objectStore("roms").getAll();m.onerror=()=>{c([])},m.onsuccess=()=>{c(m.result)}})}async function s(c,g){return new Promise((u,y)=>{const m={timestamp:Date.now(),romHash:c,state:g},S=e.transaction(["saves"],"readwrite").objectStore("saves").put(m);S.onerror=y,S.onsuccess=()=>{u(m.timestamp)}})}async function a(c){return new Promise((g,u)=>{const p=e.transaction(["saves"],"readonly").objectStore("saves").get(c);p.onerror=u,p.onsuccess=()=>{p.result==null?u(new Error(`Save with timestamp ${c} not found`)):g(p.result)}})}async function o(c){return new Promise((g,u)=>{const v=e.transaction(["saves"],"readonly").objectStore("saves").index("romHash").openCursor(IDBKeyRange.only(c),"prev");v.onerror=u,v.onsuccess=()=>{v.result==null?g(null):g(v.result.value)}})}async function i(c){return new Promise((g,u)=>{const v=e.transaction(["saves"],"readonly").objectStore("saves").index("romHash").getAll(c);v.onerror=()=>{g([])},v.onsuccess=()=>{g(v.result)}})}async function f(c,g){return new Promise((u,y)=>{const m={romHash:c,data:g},S=e.transaction(["titleScreens"],"readwrite").objectStore("titleScreens").put(m);S.onerror=y,S.onsuccess=()=>{u()}})}async function l(c){return new Promise((g,u)=>{const p=e.transaction(["titleScreens"],"readonly").objectStore("titleScreens").get(c);p.onerror=u,p.onsuccess=()=>{p.result==null?g(null):g(p.result)}})}async function d(){return new Promise((c,g)=>{const m=e.transaction(["titleScreens"],"readonly").objectStore("titleScreens").getAll();m.onerror=()=>{c([])},m.onsuccess=()=>{c(m.result)}})}return{rom:{get:n,insert:t,list:r},save:{get:a,getLast:o,insert:s,list:i},titleScreen:{get:l,insert:f,list:d}}},Ne=async()=>{const e=await Ce(),t=l=>JSON.stringify({...l,controls:l.controls.ref,lastState:l.lastState!=null?ee.serialize(l.lastState):null}),n=l=>{let d=JSON.parse(l);if("version"in d&&d.version!==he)d=le();else{const c=be();c.update(d.controls),d.controls=c,d.lastState=d.lastState!=null?ee.deserialize(d.lastState):null}return d},r=(()=>{const l=localStorage.getItem(ce);return l!=null?n(l):le()})(),s=Fe();return{ref:r,subscribe:(l,d)=>{s.push({key:l,handler:d})},get:l=>r[l],set:(l,d)=>{const c=r[l];r[l]=d,s.forEach(({key:g,handler:u})=>{g===l&&u(d,c)})},save:()=>{localStorage.setItem(ce,t(r))},db:e}},O=32,Be=e=>{let t=0;function n(s){e=s,t=Math.floor((O-s.width)/2),r.height=s.height}const r={state:{},width:O,height:e.height,render(s,a,o){e.render(s+t,a,o)},update:n};return n(e),r},Ge=new Uint8Array([0,0,0,0,0,0,0,0,126,129,165,129,157,185,129,126,126,255,219,255,227,199,255,126,108,254,254,254,124,56,16,0,16,56,124,254,124,56,16,0,56,124,56,254,254,16,16,124,0,24,60,126,255,126,24,126,0,0,24,60,60,24,0,0,255,255,231,195,195,231,255,255,0,60,102,66,66,102,60,0,255,195,153,189,189,153,195,255,15,7,15,125,204,204,204,120,60,102,102,102,60,24,126,24,63,51,63,48,48,112,240,224,127,99,127,99,99,103,230,192,153,90,60,231,231,60,90,153,128,224,248,254,248,224,128,0,2,14,62,254,62,14,2,0,24,60,126,24,24,126,60,24,102,102,102,102,102,0,102,0,127,219,219,123,27,27,27,0,63,96,124,102,102,62,6,252,0,0,0,0,126,126,126,0,24,60,126,24,126,60,24,255,24,60,126,24,24,24,24,0,24,24,24,24,126,60,24,0,0,24,12,254,12,24,0,0,0,48,96,254,96,48,0,0,0,0,192,192,192,254,0,0,0,36,102,255,102,36,0,0,0,24,60,126,255,255,0,0,0,255,255,126,60,24,0,0,0,0,0,0,0,0,0,0,24,24,24,24,24,0,24,0,108,108,108,0,0,0,0,0,108,108,254,108,254,108,108,0,24,126,192,124,6,252,24,0,0,198,204,24,48,102,198,0,56,108,56,118,220,204,118,0,48,48,96,0,0,0,0,0,12,24,48,48,48,24,12,0,48,24,12,12,12,24,48,0,0,102,60,255,60,102,0,0,0,24,24,126,24,24,0,0,0,0,0,0,0,24,24,48,0,0,0,126,0,0,0,0,0,0,0,0,0,24,24,0,6,12,24,48,96,192,128,0,124,206,222,246,230,198,124,0,24,56,24,24,24,24,126,0,124,198,6,124,192,192,254,0,252,6,6,60,6,6,252,0,12,204,204,204,254,12,12,0,254,192,252,6,6,198,124,0,124,192,192,252,198,198,124,0,254,6,6,12,24,48,48,0,124,198,198,124,198,198,124,0,124,198,198,126,6,6,124,0,0,24,24,0,0,24,24,0,0,24,24,0,0,24,24,48,12,24,48,96,48,24,12,0,0,0,126,0,126,0,0,0,48,24,12,6,12,24,48,0,60,102,12,24,24,0,24,0,124,198,222,222,222,192,126,0,56,108,198,198,254,198,198,0,252,198,198,252,198,198,252,0,124,198,192,192,192,198,124,0,248,204,198,198,198,204,248,0,254,192,192,248,192,192,254,0,254,192,192,248,192,192,192,0,124,198,192,192,206,198,124,0,198,198,198,254,198,198,198,0,126,24,24,24,24,24,126,0,6,6,6,6,6,198,124,0,198,204,216,240,216,204,198,0,192,192,192,192,192,192,254,0,198,238,254,254,214,198,198,0,198,230,246,222,206,198,198,0,124,198,198,198,198,198,124,0,252,198,198,252,192,192,192,0,124,198,198,198,214,222,124,6,252,198,198,252,216,204,198,0,124,198,192,124,6,198,124,0,255,24,24,24,24,24,24,0,198,198,198,198,198,198,254,0,198,198,198,198,198,124,56,0,198,198,198,198,214,254,108,0,198,198,108,56,108,198,198,0,198,198,198,124,24,48,224,0,254,6,12,24,48,96,254,0,60,48,48,48,48,48,60,0,192,96,48,24,12,6,2,0,60,12,12,12,12,12,60,0,16,56,108,198,0,0,0,0,0,0,0,0,0,0,0,255,24,24,12,0,0,0,0,0,0,0,124,6,126,198,126,0,192,192,192,252,198,198,252,0,0,0,124,198,192,198,124,0,6,6,6,126,198,198,126,0,0,0,124,198,254,192,124,0,28,54,48,120,48,48,120,0,0,0,126,198,198,126,6,252,192,192,252,198,198,198,198,0,24,0,56,24,24,24,60,0,6,0,6,6,6,6,198,124,192,192,204,216,248,204,198,0,56,24,24,24,24,24,60,0,0,0,204,254,254,214,214,0,0,0,252,198,198,198,198,0,0,0,124,198,198,198,124,0,0,0,252,198,198,252,192,192,0,0,126,198,198,126,6,6,0,0,252,198,192,192,192,0,0,0,126,192,124,6,252,0,24,24,126,24,24,24,14,0,0,0,198,198,198,198,126,0,0,0,198,198,198,124,56,0,0,0,198,198,214,254,108,0,0,0,198,108,56,108,198,0,0,0,198,198,198,126,6,252,0,0,254,12,56,96,254,0,14,24,24,112,24,24,14,0,24,24,24,0,24,24,24,0,112,24,24,14,24,24,112,0,118,220,0,0,0,0,0,0,0,16,56,108,198,198,254,0,124,198,192,192,192,214,124,48,198,0,198,198,198,198,126,0,14,0,124,198,254,192,124,0,126,129,60,6,126,198,126,0,102,0,124,6,126,198,126,0,224,0,124,6,126,198,126,0,24,24,124,6,126,198,126,0,0,0,124,198,192,214,124,48,126,129,124,198,254,192,124,0,102,0,124,198,254,192,124,0,224,0,124,198,254,192,124,0,102,0,56,24,24,24,60,0,124,130,56,24,24,24,60,0,112,0,56,24,24,24,60,0,198,16,124,198,254,198,198,0,56,56,0,124,198,254,198,0,14,0,254,192,248,192,254,0,0,0,127,12,127,204,127,0,63,108,204,255,204,204,207,0,124,130,124,198,198,198,124,0,102,0,124,198,198,198,124,0,224,0,124,198,198,198,124,0,124,130,0,198,198,198,126,0,224,0,198,198,198,198,126,0,102,0,102,102,102,62,6,124,198,124,198,198,198,198,124,0,198,0,198,198,198,198,254,0,24,24,126,216,216,216,126,24,56,108,96,240,96,102,252,0,102,102,60,24,126,24,126,24,248,204,204,250,198,207,198,195,14,27,24,60,24,24,216,112,14,0,124,6,126,198,126,0,28,0,56,24,24,24,60,0,14,0,124,198,198,198,124,0,14,0,198,198,198,198,126,0,0,254,0,252,198,198,198,0,254,0,198,230,246,222,206,0,60,108,108,62,0,126,0,0,60,102,102,60,0,126,0,0,24,0,24,24,48,102,60,0,0,0,0,252,192,192,0,0,0,0,0,252,12,12,0,0,198,204,216,63,99,207,140,15,195,198,204,219,55,109,207,3,24,0,24,24,24,24,24,0,0,51,102,204,102,51,0,0,0,204,102,51,102,204,0,0,34,136,34,136,34,136,34,136,85,170,85,170,85,170,85,170,221,119,221,119,221,119,221,119,24,24,24,24,24,24,24,24,24,24,24,24,248,24,24,24,24,24,248,24,248,24,24,24,54,54,54,54,246,54,54,54,0,0,0,0,254,54,54,54,0,0,248,24,248,24,24,24,54,54,246,6,246,54,54,54,54,54,54,54,54,54,54,54,0,0,254,6,246,54,54,54,54,54,246,6,254,0,0,0,54,54,54,54,254,0,0,0,24,24,248,24,248,0,0,0,0,0,0,0,248,24,24,24,24,24,24,24,31,0,0,0,24,24,24,24,255,0,0,0,0,0,0,0,255,24,24,24,24,24,24,24,31,24,24,24,0,0,0,0,255,0,0,0,24,24,24,24,255,24,24,24,24,24,31,24,31,24,24,24,54,54,54,54,55,54,54,54,54,54,55,48,63,0,0,0,0,0,63,48,55,54,54,54,54,54,247,0,255,0,0,0,0,0,255,0,247,54,54,54,54,54,55,48,55,54,54,54,0,0,255,0,255,0,0,0,54,54,247,0,247,54,54,54,24,24,255,0,255,0,0,0,54,54,54,54,255,0,0,0,0,0,255,0,255,24,24,24,0,0,0,0,255,54,54,54,54,54,54,54,63,0,0,0,24,24,31,24,31,0,0,0,0,0,31,24,31,24,24,24,0,0,0,0,63,54,54,54,54,54,54,54,255,54,54,54,24,24,255,24,255,24,24,24,24,24,24,24,248,0,0,0,0,0,0,0,31,24,24,24,255,255,255,255,255,255,255,255,0,0,0,0,255,255,255,255,240,240,240,240,240,240,240,240,15,15,15,15,15,15,15,15,255,255,255,255,0,0,0,0,0,0,118,220,200,220,118,0,56,108,108,120,108,102,108,96,0,254,198,192,192,192,192,0,0,0,254,108,108,108,108,0,254,96,48,24,48,96,254,0,0,0,126,216,216,216,112,0,0,102,102,102,102,124,96,192,0,118,220,24,24,24,24,0,126,24,60,102,102,60,24,126,60,102,195,255,195,102,60,0,60,102,195,195,102,102,231,0,14,24,12,126,198,198,124,0,0,0,126,219,219,126,0,0,6,12,126,219,219,126,96,192,56,96,192,248,192,96,56,0,120,204,204,204,204,204,204,0,0,126,0,126,0,126,0,0,24,24,126,24,24,0,126,0,96,48,24,48,96,0,252,0,24,48,96,48,24,0,252,0,14,27,27,24,24,24,24,24,24,24,24,24,24,216,216,112,24,24,0,126,0,24,24,0,0,118,220,0,118,220,0,0,56,108,108,56,0,0,0,0,0,0,0,24,24,0,0,0,0,0,0,0,24,0,0,0,15,12,12,12,236,108,60,28,120,108,108,108,108,0,0,0,124,12,124,96,124,0,0,0,0,0,60,60,60,60,0,0,0,16,0,0,0,0,0,0]);function je(e,t=63,n=48){const s=(e.charCodeAt(0)&255)*8,a=Ge.slice(s,s+8),o=new Uint8Array(64);for(let i=0;i<8;i++){const f=a[i];for(let l=0;l<8;l++)o[i*8+l]=f&1<<7-l?t:n}return o}function q(e,t,n,r,s=48,a=0){for(let o=0;o<n.length;o++)r.setTile(e+o,t,je(n[o],s,a))}const ue={textColor:48,bgColor:0,maxLength:1/0},de=(e,t)=>e.length>t?e.slice(0,t-3)+"...":e,L=(e,t=ue)=>{const n={active:!1},r={...ue,...t};e=de(e,r.maxLength);const s={state:n,width:e.length,height:1,update(a){a!==e&&(s.width=a.length,e=de(a,r.maxLength??1/0))},render:(a,o,i)=>{n.active?q(a,o,e,i,r.bgColor,r.textColor):q(a,o,e,i,r.textColor,r.bgColor)}};return s},He=(e,t)=>{let n,r=!1;switch(e){case x.UP:n="up";break;case x.LEFT:n="left";break;case x.DOWN:n="down";break;case x.RIGHT:n="right";break;case x.A:n="a";break;case x.B:n="b";break;case x.START:n="start";break;case x.SELECT:n="select";break}const s=()=>{const o=`${x[e].padEnd(6," ")}`;if(r)return`${o} > ...`;let i=t.ref.controls.ref.keyboard.inputs[n];return i===" "&&(i="space"),`${o} > ${i.toUpperCase()}`},a=L(s());return{...a,render(o,i,f){a.update(s()),a.render(o,i,f)},onKeyDown(o){return r?(t.ref.controls.setKeyboard(o,n),r=!1,a.update(s()),!0):o==="Enter"?(r=!0,!0):!1}}},We=(e,t={spacing:1,align:"start",firstIndex:0,lastIndex:e.length-1})=>{const n={...t};let r=0,s=0;for(const a of e)r=Math.max(r,a.width),s+=a.height+n.spacing;return{state:n,width:r,height:s,render(a,o,i){let f=o;for(let l=n.firstIndex;l<=n.lastIndex;l++){const d=e[l];let c;switch(n.align){case"start":c=0;break;case"center":c=(r-d.width)/2;break;case"end":c=r-d.width;break}d.render(c+a,f,i),f+=d.height+n.spacing}},update(a){e=a,n.firstIndex=0,n.lastIndex=e.length-1}}},Z=(e,{visibleItems:t=e.length,onSelect:n}={})=>{const r={activeIndex:0,items:e},s=We(e);e[0].state.active=!0;const a=i=>{e[r.activeIndex].state.active=!1,r.activeIndex=i,e[i].state.active=!0,n==null||n(i)},o=()=>{const i=s.state;r.activeIndex<i.firstIndex&&(i.firstIndex=Math.max(r.activeIndex,0),i.lastIndex=Math.min(i.firstIndex+t-1,e.length-1)),r.activeIndex>i.lastIndex&&(i.firstIndex=Math.max(r.activeIndex-t+1,0),i.lastIndex=Math.min(r.activeIndex,e.length-1))};return o(),{...s,state:r,next(){a((r.activeIndex+1)%e.length),o()},prev(){a(Math.max(r.activeIndex===0?e.length-1:r.activeIndex-1,0)),o()},update(i){s.update(i),e=i,r.items=i,r.activeIndex=0,s.state.firstIndex=0,s.state.lastIndex=Math.min(t,i.length)-1}}},qe=e=>{const t=[x.UP,x.LEFT,x.DOWN,x.RIGHT,x.A,x.B,x.START,x.SELECT].map(a=>He(a,e)),n=Z(t);return{...n,onKeyDown:a=>t[n.state.activeIndex].onKeyDown(a),setActive:a=>{}}},Ke=(e,{initialIndex:t=0,onSelect:n}={})=>{const r={active:!0,activeIndex:t};e[t].state.active=!0;const s=[];let a=0,o=0;for(let f=0;f<e.length;f++){const l=e[f];s.push(Math.round(o+l.width/2)),o+=l.width+1,a=Math.max(a,l.width)}const i=f=>{f!==r.activeIndex&&(e[r.activeIndex].state.active=!1,e[f].state.active=!0,r.activeIndex=f,n==null||n(f))};return i(t),{state:r,width:O,height:1,render(f,l,d){let c=O/2-s[r.activeIndex];for(let g=0;g<e.length;g++){const u=e[g];u.render(c,l,d),c+=u.width+1}r.activeIndex>0&&q(0,l,"< ",d),r.activeIndex<e.length-1&&q(O-2,l," >",d)},next(){i(Math.min(r.activeIndex+1,e.length-1))},prev(){i(Math.max(r.activeIndex-1,0))}}},ne=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{}catch{return!1}return"showOpenFilePicker"in self})(),$e=ne?Promise.resolve().then(function(){return Ye}):Promise.resolve().then(function(){return nt});async function Xe(...e){return(await $e).default(...e)}ne?Promise.resolve().then(function(){return Qe}):Promise.resolve().then(function(){return at});ne?Promise.resolve().then(function(){return et}):Promise.resolve().then(function(){return ot});const ze=async e=>{const t=await e.getFile();return t.handle=e,t};var Ve=async(e=[{}])=>{Array.isArray(e)||(e=[e]);const t=[];e.forEach((s,a)=>{t[a]={description:s.description||"Files",accept:{}},s.mimeTypes?s.mimeTypes.map(o=>{t[a].accept[o]=s.extensions||[]}):t[a].accept["*/*"]=s.extensions||[]});const n=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),r=await Promise.all(n.map(ze));return e[0].multiple?r:r[0]},Ye={__proto__:null,default:Ve};function V(e){function t(n){if(Object(n)!==n)return Promise.reject(new TypeError(n+" is not an object."));var r=n.done;return Promise.resolve(n.value).then(function(s){return{value:s,done:r}})}return V=function(n){this.s=n,this.n=n.next},V.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return r===void 0?Promise.resolve({value:n,done:!0}):t(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return r===void 0?Promise.reject(n):t(r.apply(this.s,arguments))}},new V(e)}const ve=async(e,t,n=e.name,r)=>{const s=[],a=[];var o,i=!1,f=!1;try{for(var l,d=function(c){var g,u,y,m=2;for(typeof Symbol<"u"&&(u=Symbol.asyncIterator,y=Symbol.iterator);m--;){if(u&&(g=c[u])!=null)return g.call(c);if(y&&(g=c[y])!=null)return new V(g.call(c));u="@@asyncIterator",y="@@iterator"}throw new TypeError("Object is not async iterable")}(e.values());i=!(l=await d.next()).done;i=!1){const c=l.value,g=`${n}/${c.name}`;c.kind==="file"?a.push(c.getFile().then(u=>(u.directoryHandle=e,u.handle=c,Object.defineProperty(u,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>g})))):c.kind!=="directory"||!t||r&&r(c)||s.push(ve(c,t,g,r))}}catch(c){f=!0,o=c}finally{try{i&&d.return!=null&&await d.return()}finally{if(f)throw o}}return[...(await Promise.all(s)).flat(),...await Promise.all(a)]};var Ze=async(e={})=>{e.recursive=e.recursive||!1,e.mode=e.mode||"read";const t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn,mode:e.mode});return(await(await t.values()).next()).done?[t]:ve(t,e.recursive,void 0,e.skipDirectory)},Qe={__proto__:null,default:Ze},Je=async(e,t=[{}],n=null,r=!1,s=null)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";const a=[];let o=null;if(e instanceof Blob&&e.type?o=e.type:e.headers&&e.headers.get("content-type")&&(o=e.headers.get("content-type")),t.forEach((l,d)=>{a[d]={description:l.description||"Files",accept:{}},l.mimeTypes?(d===0&&o&&l.mimeTypes.push(o),l.mimeTypes.map(c=>{a[d].accept[c]=l.extensions||[]})):o?a[d].accept[o]=l.extensions||[]:a[d].accept["*/*"]=l.extensions||[]}),n)try{await n.getFile()}catch(l){if(n=null,r)throw l}const i=n||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:a,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1});!n&&s&&s(i);const f=await i.createWritable();return"stream"in e?(await e.stream().pipeTo(f),i):"body"in e?(await e.body.pipeTo(f),i):(await f.write(await e),await f.close(),i)},et={__proto__:null,default:Je},tt=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,n)=>{const r=document.createElement("input");r.type="file";const s=[...e.map(f=>f.mimeTypes||[]),...e.map(f=>f.extensions||[])].join();r.multiple=e[0].multiple||!1,r.accept=s||"",r.style.display="none",document.body.append(r);const a=f=>{typeof o=="function"&&o(),t(f)},o=e[0].legacySetup&&e[0].legacySetup(a,()=>o(n),r),i=()=>{window.removeEventListener("focus",i),r.remove()};r.addEventListener("click",()=>{window.addEventListener("focus",i)}),r.addEventListener("change",()=>{window.removeEventListener("focus",i),r.remove(),a(r.multiple?Array.from(r.files):r.files[0])}),"showPicker"in HTMLInputElement.prototype?r.showPicker():r.click()})),nt={__proto__:null,default:tt},rt=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,n)=>{const r=document.createElement("input");r.type="file",r.webkitdirectory=!0;const s=o=>{typeof a=="function"&&a(),t(o)},a=e[0].legacySetup&&e[0].legacySetup(s,()=>a(n),r);r.addEventListener("change",()=>{let o=Array.from(r.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(o=o.filter(i=>i.webkitRelativePath.split("/").every(f=>!e[0].skipDirectory({name:f,kind:"directory"})))):o=o.filter(i=>i.webkitRelativePath.split("/").length===2),s(o)}),"showPicker"in HTMLInputElement.prototype?r.showPicker():r.click()})),at={__proto__:null,default:rt},st=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);const n=document.createElement("a");let r=e;"body"in e&&(r=await async function(o,i){const f=o.getReader(),l=new ReadableStream({start:g=>async function u(){return f.read().then(({done:y,value:m})=>{if(!y)return g.enqueue(m),u();g.close()})}()}),d=new Response(l),c=await d.blob();return f.releaseLock(),new Blob([c],{type:i})}(e.body,e.headers.get("content-type"))),n.download=t.fileName||"Untitled",n.href=URL.createObjectURL(await r);const s=()=>{typeof a=="function"&&a()},a=t.legacySetup&&t.legacySetup(s,()=>a(),n);return n.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(n.href),3e4),s()}),n.click(),null},ot={__proto__:null,default:st};const P=(e,t)=>({...e,enter(){t()}}),fe=22,it=e=>{const t=[P(L("Load ROMs..."),s)],n=Z(t,{visibleItems:8,onSelect:f});n.width=fe;let r=[];async function s(){try{const c=await Xe({description:"NES ROM file",extensions:[".nes"],mimeTypes:["application/octet-stream"],multiple:!0});let g=0;const u=()=>`Title Screens [${g}/${c.length}]`,y=L(u());n.update(t.concat(P(y,()=>{})));for(const m of c){try{const p=new Uint8Array(await m.arrayBuffer()),v=await e.db.rom.insert(m.name,p);c.length===1&&e.set("rom",v),await b.call("generateTitleScreen",v)}catch(p){console.error(`Failed to load file ${m.name}: ${p}`)}g+=1,y.update(u())}await o()}catch(c){console.error(c)}}function a(c){e.set("rom",c.hash)}async function o(){r=(await e.db.rom.list()).sort((c,g)=>c.name.localeCompare(g.name)),n.update(t.concat(r.map(c=>P(L(c.name,{maxLength:fe}),()=>a(c)))))}function i(){const c=n.state.activeIndex;if(c>=t.length){const g=r[c-t.length].hash;b.call("setBackground",{mode:"titleScreen",hash:g})}else b.call("setBackground",{mode:"current"})}function f(){i()}o();function l(c){return c==="start"||c==="a"?(n.state.items[n.state.activeIndex].enter(),!0):!1}function d(c){c?i():b.call("setBackground",{mode:"current"})}return{...n,onAction:l,setActive:d}},_e=({name:e,options:t,onChange:n,initialOption:r=t[0],text:s})=>{const a=L(e,s);let o;const i=f=>{o=f,a.update(e+": "+t[o]),n(t[f],f)};return i(t.indexOf(r)),{...a,onAction(f){if(a.state.active)switch(f){case"select":return i(o===0?t.length-1:o-1),!0;case"start":case"a":return i((o+1)%t.length),!0}return!1}}},ct=e=>{const t={"1x":1,"2x":2,"3x":3,"4x":4,max:50};return _e({name:"Zoom",options:["1x","2x","3x","4x","max"],initialOption:{1:"1x",2:"2x",3:"3x",4:"4x",50:"max"}[e.ref.scalingFactor],onChange:r=>e.set("scalingFactor",t[r])})},lt=e=>_e({name:"Rendering",options:["pixelated","blurry"],initialOption:e.ref.scalingMode,onChange:t=>e.set("scalingMode",t)}),ut=()=>({...P(L("Toggle Fullscreen"),()=>b.call("toggleFullscreen")),onAction(e){return e==="start"||e==="a"?(this.enter(),!0):!1}}),dt=()=>({...P(L("Soft Reset (CTRL+R)"),()=>{b.call("softReset"),b.call("toggleUI",!1)}),onAction(e){return e==="start"||e==="a"?(this.enter(),!0):!1}}),ft=e=>{const t=Z([ct(e),lt(e),ut(),dt()]);return{...t,onAction:s=>t.state.items[t.state.activeIndex].onAction(s),setActive:s=>{}}},pt=0,gt=1,mt=e=>{const t=[P(L("Save (CTRL+S)"),()=>b.call("saveState")),P(L("Load last (CTRL+L)"),()=>b.call("loadLastSave"))],n=Z(t,{visibleItems:8,onSelect:o});n.width=19;let r=[];const s=async()=>{e.ref.rom==null?n.update(t):(r=(await e.db.save.list(e.ref.rom)).sort((l,d)=>d.timestamp-l.timestamp),n.update(t.concat(r.map(l=>{const d=new Date(l.timestamp);return P(L(`${d.toLocaleDateString()} ${d.toLocaleTimeString()}`),()=>b.call("loadSave",l.timestamp))}))))};async function a(){const l=n.state.activeIndex;switch(l){case pt:b.call("setBackground",{mode:"current"});break;case gt:if(e.ref.rom!=null){const c=await e.db.save.getLast(e.ref.rom);c!=null&&b.call("setBackground",{mode:"at",timestamp:c.timestamp})}break;default:const{timestamp:d}=r[l-t.length];b.call("setBackground",{mode:"at",timestamp:d});break}}async function o(){await a()}return s(),e.subscribe("rom",s),Y.on("saved",s),{...n,onAction:l=>l==="start"||l==="a"?(n.state.items[n.state.activeIndex].enter(),!0):!1,setActive:l=>{l?a():b.call("setBackground",{mode:"current"})}}},wt=[[0,0,0],[0,61,166],[0,18,176],[68,0,150],[161,0,94],[199,0,40],[186,6,0],[140,23,0],[92,47,0],[16,69,0],[5,74,0],[0,71,46],[0,65,102],[0,0,0],[5,5,5],[5,5,5],[199,199,199],[0,119,255],[33,85,255],[130,55,250],[235,47,181],[255,41,80],[255,34,0],[214,50,0],[196,98,0],[53,128,0],[5,143,0],[0,138,85],[0,153,204],[33,33,33],[9,9,9],[9,9,9],[255,255,255],[15,215,255],[105,162,255],[212,128,255],[255,69,243],[255,97,139],[255,136,51],[255,156,18],[250,188,32],[159,227,14],[43,240,53],[12,240,164],[5,251,255],[94,94,94],[13,13,13],[13,13,13],[255,255,255],[166,252,255],[179,236,255],[218,171,235],[255,168,249],[255,171,179],[255,210,176],[255,239,166],[255,247,156],[215,232,149],[166,237,175],[162,242,218],[153,255,252],[221,221,221],[17,17,17],[17,17,17]],pe=256,yt=240,F=32,X=30,bt=()=>{const e=[],t=new Uint8Array(64).fill(0),n=new Uint8Array(pe*yt*3).fill(0);let r=0;for(let d=0;d<F*X;d+=1)e.push(t);function s(d,c,g){d>=0&&d<F&&c>=0&&c<X&&(e[d+c*F]=g)}function a(d,c){s(d,c,t)}function o(){for(let d=0;d<F*X;d+=1)e[d]=t}function i(d,c=.2){n.set(d),r=c}function f(d,c){return Math.round(d*(1-r)+c*r)}function l(d){for(let c=0;c<X;c+=1)for(let g=0;g<F;g+=1){const u=e[g+c*F];for(let y=0;y<8;y+=1)for(let m=0;m<8;m+=1){const p=u[m+y*8],v=wt[p],S=(g*8+m+(c*8+y)*pe)*3;d[S+0]=f(v[0],n[S+0]),d[S+1]=f(v[1],n[S+1]),d[S+2]=f(v[2],n[S+2])}}}return{setTile:s,clearTile:a,clear:o,render:l,setBackground:i}},ht={info:0,error:6},vt={info:48,error:48},_t={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",Enter:"start"," ":"select"},St=e=>{const t=bt(),n=[],r={library:it(e),saves:mt(e),controls:qe(e),"misc.":ft(e)},s=Object.keys(r),a=Ke(s.map(p=>L(p)),{initialIndex:0,onSelect:f}),o=Be(r[s[a.state.activeIndex]]);let i=a.state.activeIndex;function f(p){r[s[i]].setActive(!1),r[s[p]].setActive(!0),i=p}Y.on("uiToggled",({visible:p})=>{r[s[a.state.activeIndex]].setActive(p),n.length=0});const l={render:y,screen:t,onAction:d,onKeyDown:g,onGamePad:c,alert:m,visible:!0};function d(p){var S,E;const v=s[a.state.activeIndex];if(p==="toggle_ui")return b.call("toggleUI"),!0;if(l.visible){if(((E=(S=r[v]).onAction)==null?void 0:E.call(S,p))??!1)return!0;switch(p){case"left":if(l.visible)return a.prev(),o.update(r[s[a.state.activeIndex]]),!0;break;case"right":if(l.visible)return a.next(),o.update(r[s[a.state.activeIndex]]),!0;break;case"down":if(l.visible)return r[v].next(),!0;break;case"up":if(l.visible)return r[v].prev(),!0;break}}return!1}function c(p){var v,S;if(l.visible){const E=s[a.state.activeIndex];(S=(v=r[E]).onGamePad)==null||S.call(v,p)}}function g(p){var v,S;if(l.visible){if((S=(v=r[s[a.state.activeIndex]]).onKeyDown)==null?void 0:S.call(v,p))return!0;const k=_t[p];if(k)return d(k)}return!1}function u(){if(n.length>0){const p=n[0];if(p.frames>0){const v=vt[p.type],S=ht[p.type],E=p.text.slice(0,O);q(O-E.length,2,E,t,v,S),p.frames-=1}else n.shift()}}function y(p){t.clear(),a.render(0,6,t),o.render(0,9,t),u(),t.render(p)}function m(p){n.push(p)}return l},C=256,N=240,xt=0,At=1,te=2,Et={[xt]:1024,[At]:512,[te]:1024},ge={pixelated:"pixelated",blurry:"auto"};async function It(){await ye(),G.initPanicHook();const e=await Ne(),t=St(e),n=te,r=Et[n],s=n===te,a=document.querySelector("#screen"),o=Oe(a);let i;const f=Me(e),l=new Uint8Array(C*N*3),d=new AudioContext,c=new Uint8Array(C*N*3);function g(w){try{return w()}catch(h){throw t.alert({text:`${h}`,type:"error",frames:2.5*60}),h}}a.width=C,a.height=N,a.style.imageRendering=ge[e.ref.scalingMode];function u(){const w=window.innerWidth,h=window.innerHeight,I=Math.min(w/C,h/N,e.ref.scalingFactor);a.style.width=`${C*I}px`,a.style.height=`${N*I}px`}u(),window.addEventListener("resize",u),e.subscribe("scalingFactor",u),e.subscribe("scalingMode",()=>{a.style.imageRendering=ge[e.ref.scalingMode]}),b.register("toggleUI",async w=>{w!==void 0?t.visible=w:t.visible=!t.visible,t.visible?(c.set(l),b.call("setBackground",{mode:"current"}),await d.suspend()):i!==void 0&&(i.clearAudioBuffer(),await d.resume()),Y.emit("uiToggled",{visible:t.visible})}),window.addEventListener("blur",()=>{t.visible||b.call("toggleUI")});const y=d.createScriptProcessor(r,0,1);y.onaudioprocess=(()=>w=>{if(!t.visible){const h=w.outputBuffer.getChannelData(0);i.fillAudioBuffer(h,s)}})(),y.connect(d.destination),b.register("input",(w,h)=>{h&&t.onAction(w)});const m=w=>{t.onKeyDown(w.key)?w.preventDefault():f==null||f.onKeyDown(w)},p=w=>{f==null||f.onKeyUp(w)};window.addEventListener("keydown",m),window.addEventListener("keyup",p),window.addEventListener("gamepadconnected",f.onGamepadConnected),window.addEventListener("gamepaddisconnected",f.onGamepadDisconnected);function v(w){i=G.new(w,d.sampleRate),l.fill(0)}async function S(w){if(w!=null)try{const h=await e.db.rom.get(w);return v(h.data),!0}catch(h){console.error("Could not load ROM:",h),t.alert({text:`${h}`,type:"error",frames:2.5*60}),e.set("rom",null)}return!1}e.subscribe("rom",async(w,h)=>{w!=null&&(w!==h?await S(w)&&b.call("toggleUI"):b.call("toggleUI"))}),b.register("loadSave",async w=>{const h=await e.db.save.get(w);g(()=>{i.loadState(h.state),b.call("toggleUI",!1)})}),b.register("loadLastSave",async()=>{const w=await e.db.save.getLast(e.ref.rom);w!=null&&g(()=>{i.loadState(w.state),b.call("toggleUI",!1)})}),b.register("saveState",async()=>{const w=i.saveState(),h=await e.db.save.insert(e.ref.rom,w);return Y.emit("saved",{timestamp:h}),w});function E(w,h){const I=i.saveState();i.loadState(w),i.nextFrame(h),i.loadState(I)}b.register("setBackground",async w=>{switch(w.mode){case"current":{l.set(c);break}case"at":{const h=await e.db.save.get(w.timestamp);E(h.state,l);break}case"titleScreen":{if(e.ref.rom===w.hash)l.set(c);else{const h=await e.db.titleScreen.get(w.hash);h!=null?l.set(h.data):l.fill(0)}break}}t.screen.setBackground(l,.2),o.render(l)});async function k(){e.ref.rom!=null&&(await S(e.ref.rom),i&&e.ref.lastState!=null&&(i.loadState(e.ref.lastState),i.nextFrame(c),i.loadState(e.ref.lastState),b.call("setBackground",{mode:"current"}))),R()}const U=new Uint8Array(C*N*3);b.register("generateTitleScreen",async w=>{try{const h=await e.db.rom.get(w),I=await e.db.titleScreen.get(w);if(I==null){const j=G.new(h.data,d.sampleRate);for(let re=0;re<120;re++)j.nextFrame(U);return await e.db.titleScreen.insert(w,U),U}else return I.data}catch(h){return console.error(`Failed to generate title screen for ${w}: ${h}`),U.fill(0),U}}),b.register("toggleFullscreen",()=>{document.fullscreenElement?document.exitFullscreen():a.requestFullscreen()}),b.register("softReset",()=>{i==null||i.softReset()}),b.register("setJoypad1",w=>{t.visible||i==null||i.setJoypad1(w)});function A(){i!=null&&(e.ref.lastState=i.saveState()),e.save()}function R(){requestAnimationFrame(R),f.tick(),t.visible?(t.render(l),o.render(l)):i!==void 0&&(i.nextFrame(l),o.render(l))}await k(),window.addEventListener("beforeunload",A)}window.addEventListener("DOMContentLoaded",It);
