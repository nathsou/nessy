(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();let v,q=null;function j(){return(q===null||q.byteLength===0)&&(q=new Uint8Array(v.memory.buffer)),q}function ye(e,t){return e=e>>>0,j().subarray(e/1,e/1+t)}const P=new Array(128).fill(void 0);P.push(void 0,null,!0,!1);function K(e){return P[e]}let V=P.length;function Ie(e){e<132||(P[e]=V,V=e)}function se(e){const t=K(e);return Ie(e),t}const _e=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&_e.decode();function re(e,t){return e=e>>>0,_e.decode(j().subarray(e,e+t))}function G(e){V===P.length&&P.push(P.length+1);const t=V;return V=P[t],P[t]=e,t}let T=0;function z(e,t){const n=t(e.length*1,1)>>>0;return j().set(e,n/1),T=e.length,n}let $=null;function k(){return($===null||$.byteLength===0)&&($=new Int32Array(v.memory.buffer)),$}let X=null;function Ee(){return(X===null||X.byteLength===0)&&(X=new Float32Array(v.memory.buffer)),X}function ue(e,t){const n=t(e.length*4,4)>>>0;return Ee().set(e,n/4),T=e.length,n}const J=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},Te=typeof J.encodeInto=="function"?function(e,t){return J.encodeInto(e,t)}:function(e,t){const n=J.encode(e);return t.set(n),{read:e.length,written:n.length}};function Le(e,t,n){if(n===void 0){const i=J.encode(e),f=t(i.length,1)>>>0;return j().subarray(f,f+i.length).set(i),T=i.length,f}let r=e.length,s=t(r,1)>>>0;const a=j();let o=0;for(;o<r;o++){const i=e.charCodeAt(o);if(i>127)break;a[s+o]=i}if(o!==r){o!==0&&(e=e.slice(o)),s=n(s,r,r=o+e.length*3,1)>>>0;const i=j().subarray(s+o,s+r),f=Te(e,i);o+=f.written}return T=o,s}class H{static __wrap(t){t=t>>>0;const n=Object.create(H.prototype);return n.__wbg_ptr=t,n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();v.__wbg_nes_free(t)}static initPanicHook(){v.nes_initPanicHook()}static new(t,n){try{const o=v.__wbindgen_add_to_stack_pointer(-16),i=z(t,v.__wbindgen_malloc),f=T;v.nes_new(o,i,f,n);var r=k()[o/4+0],s=k()[o/4+1],a=k()[o/4+2];if(a)throw se(s);return H.__wrap(r)}finally{v.__wbindgen_add_to_stack_pointer(16)}}softReset(){v.nes_softReset(this.__wbg_ptr)}nextFrame(t){var n=z(t,v.__wbindgen_malloc),r=T;v.nes_nextFrame(this.__wbg_ptr,n,r,G(t))}nextSamples(t){var n=ue(t,v.__wbindgen_malloc),r=T;return v.nes_nextSamples(this.__wbg_ptr,n,r,G(t))!==0}fillFrameBuffer(t){var n=z(t,v.__wbindgen_malloc),r=T;v.nes_fillFrameBuffer(this.__wbg_ptr,n,r,G(t))}setJoypad1(t){v.nes_setJoypad1(this.__wbg_ptr,t)}setJoypad2(t){v.nes_setJoypad2(this.__wbg_ptr,t)}saveState(){try{const s=v.__wbindgen_add_to_stack_pointer(-16);v.nes_saveState(s,this.__wbg_ptr);var t=k()[s/4+0],n=k()[s/4+1],r=ye(t,n).slice();return v.__wbindgen_free(t,n*1),r}finally{v.__wbindgen_add_to_stack_pointer(16)}}loadState(t){try{const s=v.__wbindgen_add_to_stack_pointer(-16),a=z(t,v.__wbindgen_malloc),o=T;v.nes_loadState(s,this.__wbg_ptr,a,o);var n=k()[s/4+0],r=k()[s/4+1];if(r)throw se(n)}finally{v.__wbindgen_add_to_stack_pointer(16)}}fillAudioBuffer(t,n){var r=ue(t,v.__wbindgen_malloc),s=T;v.nes_fillAudioBuffer(this.__wbg_ptr,r,s,G(t),n)}clearAudioBuffer(){v.nes_clearAudioBuffer(this.__wbg_ptr)}}async function Re(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function ke(){const e={};return e.wbg={},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,r){new Uint8Array(K(r).buffer,K(r).byteOffset,K(r).byteLength).set(ye(t,n))},e.wbg.__wbindgen_object_drop_ref=function(t){se(t)},e.wbg.__wbindgen_string_new=function(t,n){const r=re(t,n);return G(r)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){const t=new Error;return G(t)},e.wbg.__wbg_stack_658279fe44541cf6=function(t,n){const r=K(n).stack,s=Le(r,v.__wbindgen_malloc,v.__wbindgen_realloc),a=T;k()[t/4+1]=a,k()[t/4+0]=s},e.wbg.__wbg_error_f851667af71bcfc6=function(t,n){let r,s;try{r=t,s=n,console.error(re(t,n))}finally{v.__wbindgen_free(r,s,1)}},e.wbg.__wbindgen_throw=function(t,n){throw new Error(re(t,n))},e}function Pe(e,t){return v=e.exports,be.__wbindgen_wasm_module=t,X=null,$=null,q=null,v}async function be(e){if(v!==void 0)return v;typeof e>"u"&&(e=new URL("/nessy/wasm/nessy_bg.wasm",self.location));const t=ke();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await Re(await e,t);return Pe(n,r)}const Ue=()=>{const e={};return{register(t,n){if(e[t]!=null)throw new Error(`Hook ${String(t)} is already registered`);e[t]=n},call(t,...n){const r=e[t];if(r!=null)return r.apply(null,n);throw new Error(`Hook ${String(t)} is not registered`)}}},y=Ue();var x=(e=>(e[e.A=1]="A",e[e.B=2]="B",e[e.SELECT=4]="SELECT",e[e.START=8]="START",e[e.UP=16]="UP",e[e.DOWN=32]="DOWN",e[e.LEFT=64]="LEFT",e[e.RIGHT=128]="RIGHT",e))(x||{});const F={up:16,left:64,down:32,right:128,b:2,a:1,start:8,select:4},ae={[16]:"up",[64]:"left",[32]:"down",[128]:"right",[2]:"b",[1]:"a",[8]:"start",[4]:"select"},Me={inputs:{up:"w",left:"a",down:"s",right:"d",b:"k",a:"l",start:"Enter",select:" "},meta:{toggleUI:"Escape",save:"META+s",loadLastSave:"META+l"}},Oe=17,De={inputs:{up:12,left:14,down:13,right:15,b:0,a:1,start:9,select:8},meta:{toggleUI:6,save:10,loadLastSave:11}},Fe={keyboard:Me,gamepad:De},ve=(e=Fe)=>{const t={keyboard:{inputs:{},meta:{}},gamepad:{inputs:{},meta:{}}},n=()=>JSON.stringify(e),r=s=>{for(const[a,o]of Object.entries(s.keyboard.inputs))s.keyboard.inputs[a]=o,t.keyboard.inputs[o]=F[a];for(const[a,o]of Object.entries(s.keyboard.meta))s.keyboard.meta[a]=o,t.keyboard.meta[o]=F[a];for(const[a,o]of Object.entries(s.gamepad.inputs))s.gamepad.inputs[a]=o,t.gamepad.inputs[o]=F[a];for(const[a,o]of Object.entries(s.gamepad.meta))s.gamepad.meta[a]=o,t.gamepad.meta[o]=F[a]};return r(e),{ref:e,reversed:t,setKeyboard(s,a){delete t.keyboard.inputs[e.keyboard.inputs[a]],t.keyboard.inputs[s]=F[a],e.keyboard.inputs[a]=s},setGamepad(s,a){delete t.gamepad.inputs[e.gamepad.inputs[a]],t.gamepad.inputs[s]=F[a],e.gamepad.inputs[a]=s},getKeyboard(s){return t.keyboard.inputs[s]??null},getGamepad(s){return t.gamepad.inputs[s]??null},isKeyMapped(s){return s in t.keyboard.inputs},isInputMapped(s){return s in t.gamepad.inputs},serialize:n,update:r}},Ce=e=>{let t=!1,n=-1,r=0,s=0;const a={inputs:{up:!1,left:!1,down:!1,right:!1,b:!1,a:!1,start:!1,select:!1},meta:{toggleUI:!1,save:!1,loadLastSave:!1}};async function o(u,h){if(u.key==="Meta"&&(t=h,u.preventDefault()),h&&(u.key==="Escape"||u.key==="Tab")?(u.preventDefault(),a.meta.toggleUI||(y.call("toggleUI"),a.meta.toggleUI=!0)):a.meta.toggleUI=!1,t&&h)switch(u.key){case"s":{if(u.preventDefault(),!a.meta.save){y.call("saveState"),a.meta.save=!0;return}break}case"r":{u.preventDefault(),y.call("softReset");return}case"l":{if(u.preventDefault(),!a.meta.loadLastSave){await y.call("loadLastSave"),a.meta.loadLastSave=!0;return}break}default:a.meta.save=!1,a.meta.loadLastSave=!1,u.preventDefault()}if(e.ref.controls.isKeyMapped(u.key)){(u.key==="Enter"||u.key===" ")&&u.preventDefault();const g=e.ref.controls.getKeyboard(u.key),p=ae[g];h?r|=g:r&=~g,a.inputs[p]!==h&&(y.call("input",p),a.inputs[p]=h)}}const i=u=>o(u,!0),f=u=>o(u,!1);function l(){if(n>=0){const u=navigator.getGamepads()[n];let h=s;for(let A=0;A<16;A++){const R=u.buttons[A];if(e.ref.controls.isInputMapped(A)){const w=e.ref.controls.getGamepad(A),_=ae[w];R.pressed?h|=w:h&=~w,a.inputs[_]!==R.pressed&&R.pressed&&y.call("input",_,A),a.inputs[_]=R.pressed}}for(let A=0;A<4;A++){const R=u.axes[A],w=Oe+2*A+(R<0?0:1);if(e.ref.controls.isInputMapped(w)){const _=e.ref.controls.getGamepad(w),E=Math.abs(R)>.5,W=ae[_];E?h|=_:h&=~_,a.inputs[W]!==E&&E&&y.call("input",W,w),a.inputs[W]=E}}s=h;const g=e.ref.controls.ref.gamepad.meta,p=u.buttons[g.toggleUI].pressed,b=a.meta.toggleUI,S=u.buttons[g.save].pressed,I=a.meta.save,U=u.buttons[g.loadLastSave].pressed,O=a.meta.loadLastSave;p&&!b&&y.call("toggleUI"),S&&!I&&y.call("saveState"),U&&!O&&y.call("loadLastSave"),a.meta.toggleUI=p,a.meta.save=S,a.meta.loadLastSave=U}}function d(){l();const u=r|s;y.call("setJoypad1",u)}function c(u){n=u.gamepad.index}function m(u){u.gamepad.index===n&&(n=-1)}return{onKeyDown:i,onKeyUp:f,onGamepadConnected:c,onGamepadDisconnected:m,tick:d}};function Ne(e){const t=e.getContext("webgl");if(t==null)throw new Error("Unable to get WebGL context. Your browser may not support it.");const n=t.createTexture();if(n==null)throw new Error("Unable to create texture.");t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const r=t.createBuffer();if(r==null)throw new Error("Unable to create buffer.");t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),t.STATIC_DRAW);const s=`
        attribute vec2 a_position;
        varying vec2 v_texCoord;

        void main() {
            gl_Position = vec4(a_position, 0, 1);
            v_texCoord = a_position * vec2(0.5, -0.5) + 0.5;
        }
    `,a=`
        precision mediump float;
        uniform sampler2D u_image;
        varying vec2 v_texCoord;

        void main() {
            gl_FragColor = texture2D(u_image, v_texCoord);
        }
    `,o=d(t.VERTEX_SHADER,s),i=d(t.FRAGMENT_SHADER,a),f=c(o,i),l=t.getAttribLocation(f,"a_position");t.viewport(0,0,256,240);function d(u,h){const g=t.createShader(u);if(!g)throw new Error("Unable to create shader.");if(t.shaderSource(g,h),t.compileShader(g),!t.getShaderParameter(g,t.COMPILE_STATUS))throw`Could not compile WebGL shader. 

`+t.getShaderInfoLog(g);return g}function c(u,h){const g=t.createProgram();if(!g)throw new Error("Unable to create program.");if(t.attachShader(g,u),t.attachShader(g,h),t.linkProgram(g),!t.getProgramParameter(g,t.LINK_STATUS))throw`Could not compile WebGL program. 

`+t.getProgramInfoLog(g);return g}function m(u){t.useProgram(f),t.enableVertexAttribArray(l),t.bindBuffer(t.ARRAY_BUFFER,r),t.vertexAttribPointer(l,2,t.FLOAT,!1,0,0),t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGB,e.width,e.height,0,t.RGB,t.UNSIGNED_BYTE,u),t.drawArrays(t.TRIANGLES,0,6)}return{render:m}}const Be=()=>{let e=0;const t=new Map,n={saved:[],uiToggled:[]};return{emit:(o,i)=>{n[o].forEach(({handler:f})=>f(i))},on:(o,i)=>(e+=1,n[o].push({id:e,handler:i}),t.set(e,o),e),remove:o=>{const i=t.get(o);if(i!=null){t.delete(o);const f=n[i].findIndex(l=>l.id===o);f!==-1&&n[i].splice(f,1)}}}},te=Be(),Ge=()=>[],Z=e=>e,de="nessy.store",Se=2,fe=()=>({version:Se,rom:Z(null),controls:ve(),scalingFactor:Z(4),scalingMode:Z("pixelated"),lastState:Z(null)}),oe={serialize(e){return Array.from(e).map(t=>String.fromCharCode(t)).join("")},deserialize(e){return Uint8Array.from(e.split("").map(t=>t.charCodeAt(0)))},async hash(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(n=>n.toString(16).padStart(2,"0")).join("")}},je=async()=>{const e=await new Promise((c,m)=>{const u=indexedDB.open("nessy",1);u.onerror=m,u.onupgradeneeded=()=>{const h=u.result,g=h.createObjectStore("roms",{keyPath:"hash"});g.createIndex("hash","hash",{unique:!0}),g.createIndex("name","name",{unique:!1}),g.createIndex("data","data",{unique:!1});const p=h.createObjectStore("saves",{keyPath:"timestamp"});p.createIndex("timestamp","timestamp",{unique:!0}),p.createIndex("romHash","romHash",{unique:!1}),p.createIndex("state","state",{unique:!1});const b=h.createObjectStore("titleScreens",{keyPath:"romHash"});b.createIndex("romHash","romHash",{unique:!0}),b.createIndex("data","data",{unique:!1})},u.onsuccess=()=>{c(u.result)}});async function t(c,m){const u={hash:await oe.hash(m),name:c.endsWith(".nes")?c.slice(0,-4):c,data:m},p=e.transaction(["roms"],"readwrite").objectStore("roms").put(u);return new Promise((b,S)=>{p.onerror=S,p.onsuccess=()=>{b(u.hash)}})}async function n(c){return new Promise((m,u)=>{const p=e.transaction(["roms"],"readonly").objectStore("roms").get(c);p.onerror=u,p.onsuccess=()=>{p.result==null?u(new Error(`ROM with hash ${c} not found`)):m(p.result)}})}async function r(){return new Promise((c,m)=>{const g=e.transaction(["roms"],"readonly").objectStore("roms").getAll();g.onerror=()=>{c([])},g.onsuccess=()=>{c(g.result)}})}async function s(c,m){return new Promise((u,h)=>{const g={timestamp:Date.now(),romHash:c,state:m},S=e.transaction(["saves"],"readwrite").objectStore("saves").put(g);S.onerror=h,S.onsuccess=()=>{u(g.timestamp)}})}async function a(c){return new Promise((m,u)=>{const p=e.transaction(["saves"],"readonly").objectStore("saves").get(c);p.onerror=u,p.onsuccess=()=>{p.result==null?u(new Error(`Save with timestamp ${c} not found`)):m(p.result)}})}async function o(c){return new Promise((m,u)=>{const b=e.transaction(["saves"],"readonly").objectStore("saves").index("romHash").openCursor(IDBKeyRange.only(c),"prev");b.onerror=u,b.onsuccess=()=>{b.result==null?m(null):m(b.result.value)}})}async function i(c){return new Promise((m,u)=>{const b=e.transaction(["saves"],"readonly").objectStore("saves").index("romHash").getAll(c);b.onerror=()=>{m([])},b.onsuccess=()=>{m(b.result)}})}async function f(c,m){return new Promise((u,h)=>{const g={romHash:c,data:m},S=e.transaction(["titleScreens"],"readwrite").objectStore("titleScreens").put(g);S.onerror=h,S.onsuccess=()=>{u()}})}async function l(c){return new Promise((m,u)=>{const p=e.transaction(["titleScreens"],"readonly").objectStore("titleScreens").get(c);p.onerror=u,p.onsuccess=()=>{p.result==null?m(null):m(p.result)}})}async function d(){return new Promise((c,m)=>{const g=e.transaction(["titleScreens"],"readonly").objectStore("titleScreens").getAll();g.onerror=()=>{c([])},g.onsuccess=()=>{c(g.result)}})}return{rom:{get:n,insert:t,list:r},save:{get:a,getLast:o,insert:s,list:i},titleScreen:{get:l,insert:f,list:d}}},He=async()=>{const e=await je(),t=l=>JSON.stringify({...l,controls:l.controls.ref,lastState:l.lastState!=null?oe.serialize(l.lastState):null}),n=l=>{let d=JSON.parse(l);if("version"in d&&d.version!==Se)d=fe();else{const c=ve();c.update(d.controls),d.controls=c,d.lastState=d.lastState!=null?oe.deserialize(d.lastState):null}return d},r=(()=>{const l=localStorage.getItem(de);return l!=null?n(l):fe()})(),s=Ge();return{ref:r,subscribe:(l,d)=>{s.push({key:l,handler:d})},get:l=>r[l],set:(l,d)=>{const c=r[l];r[l]=d,s.forEach(({key:m,handler:u})=>{m===l&&u(d,c)})},save:()=>{localStorage.setItem(de,t(r))},db:e}},D=32,We=e=>{let t=0;function n(s){e=s,t=Math.floor((D-s.width)/2),r.height=s.height}const r={state:{},width:D,height:e.height,render(s,a,o){e.render(s+t,a,o)},update:n};return n(e),r},qe=new Uint8Array([0,0,0,0,0,0,0,0,126,129,165,129,157,185,129,126,126,255,219,255,227,199,255,126,108,254,254,254,124,56,16,0,16,56,124,254,124,56,16,0,56,124,56,254,254,16,16,124,0,24,60,126,255,126,24,126,0,0,24,60,60,24,0,0,255,255,231,195,195,231,255,255,0,60,102,66,66,102,60,0,255,195,153,189,189,153,195,255,15,7,15,125,204,204,204,120,60,102,102,102,60,24,126,24,63,51,63,48,48,112,240,224,127,99,127,99,99,103,230,192,153,90,60,231,231,60,90,153,128,224,248,254,248,224,128,0,2,14,62,254,62,14,2,0,24,60,126,24,24,126,60,24,102,102,102,102,102,0,102,0,127,219,219,123,27,27,27,0,63,96,124,102,102,62,6,252,0,0,0,0,126,126,126,0,24,60,126,24,126,60,24,255,24,60,126,24,24,24,24,0,24,24,24,24,126,60,24,0,0,24,12,254,12,24,0,0,0,48,96,254,96,48,0,0,0,0,192,192,192,254,0,0,0,36,102,255,102,36,0,0,0,24,60,126,255,255,0,0,0,255,255,126,60,24,0,0,0,0,0,0,0,0,0,0,24,24,24,24,24,0,24,0,108,108,108,0,0,0,0,0,108,108,254,108,254,108,108,0,24,126,192,124,6,252,24,0,0,198,204,24,48,102,198,0,56,108,56,118,220,204,118,0,48,48,96,0,0,0,0,0,12,24,48,48,48,24,12,0,48,24,12,12,12,24,48,0,0,102,60,255,60,102,0,0,0,24,24,126,24,24,0,0,0,0,0,0,0,24,24,48,0,0,0,126,0,0,0,0,0,0,0,0,0,24,24,0,6,12,24,48,96,192,128,0,124,206,222,246,230,198,124,0,24,56,24,24,24,24,126,0,124,198,6,124,192,192,254,0,252,6,6,60,6,6,252,0,12,204,204,204,254,12,12,0,254,192,252,6,6,198,124,0,124,192,192,252,198,198,124,0,254,6,6,12,24,48,48,0,124,198,198,124,198,198,124,0,124,198,198,126,6,6,124,0,0,24,24,0,0,24,24,0,0,24,24,0,0,24,24,48,12,24,48,96,48,24,12,0,0,0,126,0,126,0,0,0,48,24,12,6,12,24,48,0,60,102,12,24,24,0,24,0,124,198,222,222,222,192,126,0,56,108,198,198,254,198,198,0,252,198,198,252,198,198,252,0,124,198,192,192,192,198,124,0,248,204,198,198,198,204,248,0,254,192,192,248,192,192,254,0,254,192,192,248,192,192,192,0,124,198,192,192,206,198,124,0,198,198,198,254,198,198,198,0,126,24,24,24,24,24,126,0,6,6,6,6,6,198,124,0,198,204,216,240,216,204,198,0,192,192,192,192,192,192,254,0,198,238,254,254,214,198,198,0,198,230,246,222,206,198,198,0,124,198,198,198,198,198,124,0,252,198,198,252,192,192,192,0,124,198,198,198,214,222,124,6,252,198,198,252,216,204,198,0,124,198,192,124,6,198,124,0,255,24,24,24,24,24,24,0,198,198,198,198,198,198,254,0,198,198,198,198,198,124,56,0,198,198,198,198,214,254,108,0,198,198,108,56,108,198,198,0,198,198,198,124,24,48,224,0,254,6,12,24,48,96,254,0,60,48,48,48,48,48,60,0,192,96,48,24,12,6,2,0,60,12,12,12,12,12,60,0,16,56,108,198,0,0,0,0,0,0,0,0,0,0,0,255,24,24,12,0,0,0,0,0,0,0,124,6,126,198,126,0,192,192,192,252,198,198,252,0,0,0,124,198,192,198,124,0,6,6,6,126,198,198,126,0,0,0,124,198,254,192,124,0,28,54,48,120,48,48,120,0,0,0,126,198,198,126,6,252,192,192,252,198,198,198,198,0,24,0,56,24,24,24,60,0,6,0,6,6,6,6,198,124,192,192,204,216,248,204,198,0,56,24,24,24,24,24,60,0,0,0,204,254,254,214,214,0,0,0,252,198,198,198,198,0,0,0,124,198,198,198,124,0,0,0,252,198,198,252,192,192,0,0,126,198,198,126,6,6,0,0,252,198,192,192,192,0,0,0,126,192,124,6,252,0,24,24,126,24,24,24,14,0,0,0,198,198,198,198,126,0,0,0,198,198,198,124,56,0,0,0,198,198,214,254,108,0,0,0,198,108,56,108,198,0,0,0,198,198,198,126,6,252,0,0,254,12,56,96,254,0,14,24,24,112,24,24,14,0,24,24,24,0,24,24,24,0,112,24,24,14,24,24,112,0,118,220,0,0,0,0,0,0,0,16,56,108,198,198,254,0,124,198,192,192,192,214,124,48,198,0,198,198,198,198,126,0,14,0,124,198,254,192,124,0,126,129,60,6,126,198,126,0,102,0,124,6,126,198,126,0,224,0,124,6,126,198,126,0,24,24,124,6,126,198,126,0,0,0,124,198,192,214,124,48,126,129,124,198,254,192,124,0,102,0,124,198,254,192,124,0,224,0,124,198,254,192,124,0,102,0,56,24,24,24,60,0,124,130,56,24,24,24,60,0,112,0,56,24,24,24,60,0,198,16,124,198,254,198,198,0,56,56,0,124,198,254,198,0,14,0,254,192,248,192,254,0,0,0,127,12,127,204,127,0,63,108,204,255,204,204,207,0,124,130,124,198,198,198,124,0,102,0,124,198,198,198,124,0,224,0,124,198,198,198,124,0,124,130,0,198,198,198,126,0,224,0,198,198,198,198,126,0,102,0,102,102,102,62,6,124,198,124,198,198,198,198,124,0,198,0,198,198,198,198,254,0,24,24,126,216,216,216,126,24,56,108,96,240,96,102,252,0,102,102,60,24,126,24,126,24,248,204,204,250,198,207,198,195,14,27,24,60,24,24,216,112,14,0,124,6,126,198,126,0,28,0,56,24,24,24,60,0,14,0,124,198,198,198,124,0,14,0,198,198,198,198,126,0,0,254,0,252,198,198,198,0,254,0,198,230,246,222,206,0,60,108,108,62,0,126,0,0,60,102,102,60,0,126,0,0,24,0,24,24,48,102,60,0,0,0,0,252,192,192,0,0,0,0,0,252,12,12,0,0,198,204,216,63,99,207,140,15,195,198,204,219,55,109,207,3,24,0,24,24,24,24,24,0,0,51,102,204,102,51,0,0,0,204,102,51,102,204,0,0,34,136,34,136,34,136,34,136,85,170,85,170,85,170,85,170,221,119,221,119,221,119,221,119,24,24,24,24,24,24,24,24,24,24,24,24,248,24,24,24,24,24,248,24,248,24,24,24,54,54,54,54,246,54,54,54,0,0,0,0,254,54,54,54,0,0,248,24,248,24,24,24,54,54,246,6,246,54,54,54,54,54,54,54,54,54,54,54,0,0,254,6,246,54,54,54,54,54,246,6,254,0,0,0,54,54,54,54,254,0,0,0,24,24,248,24,248,0,0,0,0,0,0,0,248,24,24,24,24,24,24,24,31,0,0,0,24,24,24,24,255,0,0,0,0,0,0,0,255,24,24,24,24,24,24,24,31,24,24,24,0,0,0,0,255,0,0,0,24,24,24,24,255,24,24,24,24,24,31,24,31,24,24,24,54,54,54,54,55,54,54,54,54,54,55,48,63,0,0,0,0,0,63,48,55,54,54,54,54,54,247,0,255,0,0,0,0,0,255,0,247,54,54,54,54,54,55,48,55,54,54,54,0,0,255,0,255,0,0,0,54,54,247,0,247,54,54,54,24,24,255,0,255,0,0,0,54,54,54,54,255,0,0,0,0,0,255,0,255,24,24,24,0,0,0,0,255,54,54,54,54,54,54,54,63,0,0,0,24,24,31,24,31,0,0,0,0,0,31,24,31,24,24,24,0,0,0,0,63,54,54,54,54,54,54,54,255,54,54,54,24,24,255,24,255,24,24,24,24,24,24,24,248,0,0,0,0,0,0,0,31,24,24,24,255,255,255,255,255,255,255,255,0,0,0,0,255,255,255,255,240,240,240,240,240,240,240,240,15,15,15,15,15,15,15,15,255,255,255,255,0,0,0,0,0,0,118,220,200,220,118,0,56,108,108,120,108,102,108,96,0,254,198,192,192,192,192,0,0,0,254,108,108,108,108,0,254,96,48,24,48,96,254,0,0,0,126,216,216,216,112,0,0,102,102,102,102,124,96,192,0,118,220,24,24,24,24,0,126,24,60,102,102,60,24,126,60,102,195,255,195,102,60,0,60,102,195,195,102,102,231,0,14,24,12,126,198,198,124,0,0,0,126,219,219,126,0,0,6,12,126,219,219,126,96,192,56,96,192,248,192,96,56,0,120,204,204,204,204,204,204,0,0,126,0,126,0,126,0,0,24,24,126,24,24,0,126,0,96,48,24,48,96,0,252,0,24,48,96,48,24,0,252,0,14,27,27,24,24,24,24,24,24,24,24,24,24,216,216,112,24,24,0,126,0,24,24,0,0,118,220,0,118,220,0,0,56,108,108,56,0,0,0,0,0,0,0,24,24,0,0,0,0,0,0,0,24,0,0,0,15,12,12,12,236,108,60,28,120,108,108,108,108,0,0,0,124,12,124,96,124,0,0,0,0,0,60,60,60,60,0,0,0,16,0,0,0,0,0,0]);function Ke(e,t=63,n=48){const s=(e.charCodeAt(0)&255)*8,a=qe.slice(s,s+8),o=new Uint8Array(64);for(let i=0;i<8;i++){const f=a[i];for(let l=0;l<8;l++)o[i*8+l]=f&1<<7-l?t:n}return o}function Y(e,t,n,r,s=48,a=0){for(let o=0;o<n.length;o++)r.setTile(e+o,t,Ke(n[o],s,a))}const pe={textColor:48,bgColor:0,maxLength:1/0},me=(e,t)=>e.length>t?e.slice(0,t-3)+"...":e,L=(e,t=pe)=>{const n={active:!1},r={...pe,...t};e=me(e,r.maxLength);const s={state:n,width:e.length,height:1,update(a){a!==e&&(s.width=a.length,e=me(a,r.maxLength??1/0))},render:(a,o,i)=>{n.active?Y(a,o,e,i,r.bgColor,r.textColor):Y(a,o,e,i,r.textColor,r.bgColor)}};return s},$e=(e,t)=>{let n,r=!1;switch(e){case x.UP:n="up";break;case x.LEFT:n="left";break;case x.DOWN:n="down";break;case x.RIGHT:n="right";break;case x.A:n="a";break;case x.B:n="b";break;case x.START:n="start";break;case x.SELECT:n="select";break}const s=()=>{const o=`${x[e].padEnd(6," ")}`;if(r)return`${o} > ...`;let i=t.ref.controls.ref.keyboard.inputs[n];return i===" "&&(i="space"),`${o} > ${i.toUpperCase()}`},a=L(s());return{...a,render(o,i,f){a.update(s()),a.render(o,i,f)},onKeyDown(o){return r?(t.ref.controls.setKeyboard(o,n),r=!1,a.update(s()),!0):o==="Enter"?(r=!0,!0):!1}}},Xe=(e,t={spacing:1,align:"start",firstIndex:0,lastIndex:e.length-1})=>{const n={...t};let r=0,s=0;for(const a of e)r=Math.max(r,a.width),s+=a.height+n.spacing;return{state:n,width:r,height:s,render(a,o,i){let f=o;for(let l=n.firstIndex;l<=n.lastIndex;l++){const d=e[l];let c;switch(n.align){case"start":c=0;break;case"center":c=(r-d.width)/2;break;case"end":c=r-d.width;break}d.render(c+a,f,i),f+=d.height+n.spacing}},update(a){e=a,n.firstIndex=0,n.lastIndex=e.length-1}}},ne=(e,{visibleItems:t=e.length,onSelect:n}={})=>{const r={activeIndex:0,items:e},s=Xe(e);e[0].state.active=!0;const a=i=>{e[r.activeIndex].state.active=!1,r.activeIndex=i,e[i].state.active=!0,n==null||n(i)},o=()=>{const i=s.state;r.activeIndex<i.firstIndex&&(i.firstIndex=Math.max(r.activeIndex,0),i.lastIndex=Math.min(i.firstIndex+t-1,e.length-1)),r.activeIndex>i.lastIndex&&(i.firstIndex=Math.max(r.activeIndex-t+1,0),i.lastIndex=Math.min(r.activeIndex,e.length-1))};return o(),{...s,state:r,next(){a((r.activeIndex+1)%e.length),o()},prev(){a(Math.max(r.activeIndex===0?e.length-1:r.activeIndex-1,0)),o()},update(i){s.update(i),e=i,r.items=i,r.activeIndex=0,s.state.firstIndex=0,s.state.lastIndex=Math.min(t,i.length)-1}}},Ve=e=>{const t=[x.UP,x.LEFT,x.DOWN,x.RIGHT,x.A,x.B,x.START,x.SELECT].map(a=>$e(a,e)),n=ne(t);return{...n,onKeyDown:a=>t[n.state.activeIndex].onKeyDown(a),setActive:a=>{}}},Ye=(e,{initialIndex:t=0,onSelect:n}={})=>{const r={active:!0,activeIndex:t};e[t].state.active=!0;const s=[];let a=0,o=0;for(let f=0;f<e.length;f++){const l=e[f];s.push(Math.round(o+l.width/2)),o+=l.width+1,a=Math.max(a,l.width)}const i=f=>{f!==r.activeIndex&&(e[r.activeIndex].state.active=!1,e[f].state.active=!0,r.activeIndex=f,n==null||n(f))};return i(t),{state:r,width:D,height:1,render(f,l,d){let c=D/2-s[r.activeIndex];for(let m=0;m<e.length;m++){const u=e[m];u.render(c,l,d),c+=u.width+1}r.activeIndex>0&&Y(0,l,"< ",d),r.activeIndex<e.length-1&&Y(D-2,l," >",d)},next(){i(Math.min(r.activeIndex+1,e.length-1))},prev(){i(Math.max(r.activeIndex-1,0))}}},ce=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{}catch{return!1}return"showOpenFilePicker"in self})(),ze=ce?Promise.resolve().then(function(){return et}):Promise.resolve().then(function(){return ot});async function Ze(...e){return(await ze).default(...e)}ce?Promise.resolve().then(function(){return nt}):Promise.resolve().then(function(){return ct});ce?Promise.resolve().then(function(){return at}):Promise.resolve().then(function(){return ut});const Qe=async e=>{const t=await e.getFile();return t.handle=e,t};var Je=async(e=[{}])=>{Array.isArray(e)||(e=[e]);const t=[];e.forEach((s,a)=>{t[a]={description:s.description||"Files",accept:{}},s.mimeTypes?s.mimeTypes.map(o=>{t[a].accept[o]=s.extensions||[]}):t[a].accept["*/*"]=s.extensions||[]});const n=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),r=await Promise.all(n.map(Qe));return e[0].multiple?r:r[0]},et={__proto__:null,default:Je};function ee(e){function t(n){if(Object(n)!==n)return Promise.reject(new TypeError(n+" is not an object."));var r=n.done;return Promise.resolve(n.value).then(function(s){return{value:s,done:r}})}return ee=function(n){this.s=n,this.n=n.next},ee.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return r===void 0?Promise.resolve({value:n,done:!0}):t(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return r===void 0?Promise.reject(n):t(r.apply(this.s,arguments))}},new ee(e)}const xe=async(e,t,n=e.name,r)=>{const s=[],a=[];var o,i=!1,f=!1;try{for(var l,d=function(c){var m,u,h,g=2;for(typeof Symbol<"u"&&(u=Symbol.asyncIterator,h=Symbol.iterator);g--;){if(u&&(m=c[u])!=null)return m.call(c);if(h&&(m=c[h])!=null)return new ee(m.call(c));u="@@asyncIterator",h="@@iterator"}throw new TypeError("Object is not async iterable")}(e.values());i=!(l=await d.next()).done;i=!1){const c=l.value,m=`${n}/${c.name}`;c.kind==="file"?a.push(c.getFile().then(u=>(u.directoryHandle=e,u.handle=c,Object.defineProperty(u,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>m})))):c.kind!=="directory"||!t||r&&r(c)||s.push(xe(c,t,m,r))}}catch(c){f=!0,o=c}finally{try{i&&d.return!=null&&await d.return()}finally{if(f)throw o}}return[...(await Promise.all(s)).flat(),...await Promise.all(a)]};var tt=async(e={})=>{e.recursive=e.recursive||!1,e.mode=e.mode||"read";const t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn,mode:e.mode});return(await(await t.values()).next()).done?[t]:xe(t,e.recursive,void 0,e.skipDirectory)},nt={__proto__:null,default:tt},rt=async(e,t=[{}],n=null,r=!1,s=null)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";const a=[];let o=null;if(e instanceof Blob&&e.type?o=e.type:e.headers&&e.headers.get("content-type")&&(o=e.headers.get("content-type")),t.forEach((l,d)=>{a[d]={description:l.description||"Files",accept:{}},l.mimeTypes?(d===0&&o&&l.mimeTypes.push(o),l.mimeTypes.map(c=>{a[d].accept[c]=l.extensions||[]})):o?a[d].accept[o]=l.extensions||[]:a[d].accept["*/*"]=l.extensions||[]}),n)try{await n.getFile()}catch(l){if(n=null,r)throw l}const i=n||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:a,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1});!n&&s&&s(i);const f=await i.createWritable();return"stream"in e?(await e.stream().pipeTo(f),i):"body"in e?(await e.body.pipeTo(f),i):(await f.write(await e),await f.close(),i)},at={__proto__:null,default:rt},st=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,n)=>{const r=document.createElement("input");r.type="file";const s=[...e.map(f=>f.mimeTypes||[]),...e.map(f=>f.extensions||[])].join();r.multiple=e[0].multiple||!1,r.accept=s||"",r.style.display="none",document.body.append(r);const a=f=>{typeof o=="function"&&o(),t(f)},o=e[0].legacySetup&&e[0].legacySetup(a,()=>o(n),r),i=()=>{window.removeEventListener("focus",i),r.remove()};r.addEventListener("click",()=>{window.addEventListener("focus",i)}),r.addEventListener("change",()=>{window.removeEventListener("focus",i),r.remove(),a(r.multiple?Array.from(r.files):r.files[0])}),"showPicker"in HTMLInputElement.prototype?r.showPicker():r.click()})),ot={__proto__:null,default:st},it=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,n)=>{const r=document.createElement("input");r.type="file",r.webkitdirectory=!0;const s=o=>{typeof a=="function"&&a(),t(o)},a=e[0].legacySetup&&e[0].legacySetup(s,()=>a(n),r);r.addEventListener("change",()=>{let o=Array.from(r.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(o=o.filter(i=>i.webkitRelativePath.split("/").every(f=>!e[0].skipDirectory({name:f,kind:"directory"})))):o=o.filter(i=>i.webkitRelativePath.split("/").length===2),s(o)}),"showPicker"in HTMLInputElement.prototype?r.showPicker():r.click()})),ct={__proto__:null,default:it},lt=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);const n=document.createElement("a");let r=e;"body"in e&&(r=await async function(o,i){const f=o.getReader(),l=new ReadableStream({start:m=>async function u(){return f.read().then(({done:h,value:g})=>{if(!h)return m.enqueue(g),u();m.close()})}()}),d=new Response(l),c=await d.blob();return f.releaseLock(),new Blob([c],{type:i})}(e.body,e.headers.get("content-type"))),n.download=t.fileName||"Untitled",n.href=URL.createObjectURL(await r);const s=()=>{typeof a=="function"&&a()},a=t.legacySetup&&t.legacySetup(s,()=>a(),n);return n.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(n.href),3e4),s()}),n.click(),null},ut={__proto__:null,default:lt};const M=(e,t)=>({...e,enter(){t()}}),ge=22,dt=e=>{const t=[M(L("Load ROMs..."),s)],n=ne(t,{visibleItems:8,onSelect:f});n.width=ge;let r=[];async function s(){try{const c=await Ze({description:"NES ROM file",extensions:[".nes"],mimeTypes:["application/octet-stream"],multiple:!0});let m=0;const u=()=>`Title Screens [${m}/${c.length}]`,h=L(u());n.update(t.concat(M(h,()=>{})));for(const g of c){try{const p=new Uint8Array(await g.arrayBuffer()),b=await e.db.rom.insert(g.name,p);c.length===1&&e.set("rom",b),await y.call("generateTitleScreen",b)}catch(p){console.error(`Failed to load file ${g.name}: ${p}`)}m+=1,h.update(u())}await o()}catch(c){console.error(c)}}function a(c){e.set("rom",c.hash)}async function o(){r=(await e.db.rom.list()).sort((c,m)=>c.name.localeCompare(m.name)),n.update(t.concat(r.map(c=>M(L(c.name,{maxLength:ge}),()=>a(c)))))}function i(){const c=n.state.activeIndex;if(c>=t.length){const m=r[c-t.length].hash;y.call("setBackground",{mode:"titleScreen",hash:m})}else y.call("setBackground",{mode:"current"})}function f(){i()}o();function l(c){return c==="start"||c==="a"?(n.state.items[n.state.activeIndex].enter(),!0):!1}function d(c){c?i():y.call("setBackground",{mode:"current"})}return{...n,onAction:l,setActive:d}},Ae=({name:e,options:t,onChange:n,initialOption:r=t[0],text:s})=>{const a=L(e,s);let o;const i=f=>{o=f,a.update(e+": "+t[o]),n(t[f],f)};return i(t.indexOf(r)),{...a,onAction(f){if(a.state.active)switch(f){case"select":return i(o===0?t.length-1:o-1),!0;case"start":case"a":return i((o+1)%t.length),!0}return!1}}},ft=e=>{const t={"1x":1,"2x":2,"3x":3,"4x":4,max:50};return Ae({name:"Zoom",options:["1x","2x","3x","4x","max"],initialOption:{1:"1x",2:"2x",3:"3x",4:"4x",50:"max"}[e.ref.scalingFactor],onChange:r=>e.set("scalingFactor",t[r])})},pt=e=>Ae({name:"Rendering",options:["pixelated","blurry"],initialOption:e.ref.scalingMode,onChange:t=>e.set("scalingMode",t)}),mt=()=>({...M(L("Toggle Fullscreen"),()=>y.call("toggleFullscreen")),onAction(e){return e==="start"||e==="a"?(this.enter(),!0):!1}}),gt=()=>({...M(L("Soft Reset (CTRL+R)"),()=>{y.call("softReset"),y.call("toggleUI",!1)}),onAction(e){return e==="start"||e==="a"?(this.enter(),!0):!1}}),wt=e=>{const t=ne([ft(e),pt(e),mt(),gt()]);return{...t,onAction:s=>t.state.items[t.state.activeIndex].onAction(s),setActive:s=>{}}},ht=0,yt=1,_t=e=>{const t=[M(L("Save (CTRL+S)"),()=>y.call("saveState")),M(L("Load last (CTRL+L)"),()=>y.call("loadLastSave"))],n=ne(t,{visibleItems:8,onSelect:o});n.width=19;let r=[];const s=async()=>{e.ref.rom==null?n.update(t):(r=(await e.db.save.list(e.ref.rom)).sort((l,d)=>d.timestamp-l.timestamp),n.update(t.concat(r.map(l=>{const d=new Date(l.timestamp);return M(L(`${d.toLocaleDateString()} ${d.toLocaleTimeString()}`),()=>y.call("loadSave",l.timestamp))}))))};async function a(){const l=n.state.activeIndex;switch(l){case ht:y.call("setBackground",{mode:"current"});break;case yt:if(e.ref.rom!=null){const c=await e.db.save.getLast(e.ref.rom);c!=null&&y.call("setBackground",{mode:"at",timestamp:c.timestamp})}break;default:const{timestamp:d}=r[l-t.length];y.call("setBackground",{mode:"at",timestamp:d});break}}async function o(){await a()}return s(),e.subscribe("rom",s),te.on("saved",s),{...n,onAction:l=>l==="start"||l==="a"?(n.state.items[n.state.activeIndex].enter(),!0):!1,setActive:l=>{l?a():y.call("setBackground",{mode:"current"})}}},bt=[[0,0,0],[0,61,166],[0,18,176],[68,0,150],[161,0,94],[199,0,40],[186,6,0],[140,23,0],[92,47,0],[16,69,0],[5,74,0],[0,71,46],[0,65,102],[0,0,0],[5,5,5],[5,5,5],[199,199,199],[0,119,255],[33,85,255],[130,55,250],[235,47,181],[255,41,80],[255,34,0],[214,50,0],[196,98,0],[53,128,0],[5,143,0],[0,138,85],[0,153,204],[33,33,33],[9,9,9],[9,9,9],[255,255,255],[15,215,255],[105,162,255],[212,128,255],[255,69,243],[255,97,139],[255,136,51],[255,156,18],[250,188,32],[159,227,14],[43,240,53],[12,240,164],[5,251,255],[94,94,94],[13,13,13],[13,13,13],[255,255,255],[166,252,255],[179,236,255],[218,171,235],[255,168,249],[255,171,179],[255,210,176],[255,239,166],[255,247,156],[215,232,149],[166,237,175],[162,242,218],[153,255,252],[221,221,221],[17,17,17],[17,17,17]],we=256,vt=240,C=32,Q=30,St=()=>{const e=[],t=new Uint8Array(64).fill(0),n=new Uint8Array(we*vt*3).fill(0);let r=0;for(let d=0;d<C*Q;d+=1)e.push(t);function s(d,c,m){d>=0&&d<C&&c>=0&&c<Q&&(e[d+c*C]=m)}function a(d,c){s(d,c,t)}function o(){for(let d=0;d<C*Q;d+=1)e[d]=t}function i(d,c=.2){n.set(d),r=c}function f(d,c){return Math.round(d*(1-r)+c*r)}function l(d){for(let c=0;c<Q;c+=1)for(let m=0;m<C;m+=1){const u=e[m+c*C];for(let h=0;h<8;h+=1)for(let g=0;g<8;g+=1){const p=u[g+h*8],b=bt[p],S=(m*8+g+(c*8+h)*we)*3;d[S+0]=f(b[0],n[S+0]),d[S+1]=f(b[1],n[S+1]),d[S+2]=f(b[2],n[S+2])}}}return{setTile:s,clearTile:a,clear:o,render:l,setBackground:i}},xt={info:0,error:6},At={info:48,error:48},It={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",Enter:"start"," ":"select"},Et=e=>{const t=St(),n=[],r={library:dt(e),saves:_t(e),controls:Ve(e),"misc.":wt(e)},s=Object.keys(r),a=Ye(s.map(p=>L(p)),{initialIndex:0,onSelect:f}),o=We(r[s[a.state.activeIndex]]);let i=a.state.activeIndex;function f(p){r[s[i]].setActive(!1),r[s[p]].setActive(!0),i=p}te.on("uiToggled",({visible:p})=>{r[s[a.state.activeIndex]].setActive(p),n.length=0});const l={render:h,screen:t,onAction:d,onKeyDown:m,onGamePad:c,alert:g,visible:!0};function d(p){var S,I;const b=s[a.state.activeIndex];if(p==="toggle_ui")return y.call("toggleUI"),!0;if(l.visible){if(((I=(S=r[b]).onAction)==null?void 0:I.call(S,p))??!1)return!0;switch(p){case"left":if(l.visible)return a.prev(),o.update(r[s[a.state.activeIndex]]),!0;break;case"right":if(l.visible)return a.next(),o.update(r[s[a.state.activeIndex]]),!0;break;case"down":if(l.visible)return r[b].next(),!0;break;case"up":if(l.visible)return r[b].prev(),!0;break}}return!1}function c(p){var b,S;if(l.visible){const I=s[a.state.activeIndex];(S=(b=r[I]).onGamePad)==null||S.call(b,p)}}function m(p){var b,S;if(l.visible){if((S=(b=r[s[a.state.activeIndex]]).onKeyDown)==null?void 0:S.call(b,p))return!0;const U=It[p];if(U)return d(U)}return!1}function u(){if(n.length>0){const p=n[0];if(p.frames>0){const b=At[p.type],S=xt[p.type],I=p.text.slice(0,D);Y(D-I.length,2,I,t,b,S),p.frames-=1}else n.shift()}}function h(p){t.clear(),a.render(0,6,t),o.render(0,9,t),u(),t.render(p)}function g(p){n.push(p)}return l},N=256,B=240,Tt=0,Lt=1,ie=2,Rt={[Tt]:1024,[Lt]:512,[ie]:1024},he={pixelated:"pixelated",blurry:"auto"};async function kt(){await be(),H.initPanicHook();const e=await He(),t=Et(e),n=ie,r=Rt[n],s=n===ie,a=document.querySelector("#screen"),o=Ne(a);let i;const f=Ce(e),l=new Uint8Array(N*B*3),d=new AudioContext,c=new Uint8Array(N*B*3);function m(w){try{return w()}catch(_){throw t.alert({text:`${_}`,type:"error",frames:2.5*60}),_}}a.width=N,a.height=B,a.style.imageRendering=he[e.ref.scalingMode];function u(){const w=window.innerWidth,_=window.innerHeight,E=Math.min(w/N,_/B,e.ref.scalingFactor);a.style.width=`${N*E}px`,a.style.height=`${B*E}px`}u(),window.addEventListener("resize",u),e.subscribe("scalingFactor",u),e.subscribe("scalingMode",()=>{a.style.imageRendering=he[e.ref.scalingMode]}),y.register("toggleUI",async w=>{w!==void 0?t.visible=w:t.visible=!t.visible,t.visible?(c.set(l),y.call("setBackground",{mode:"current"}),await d.suspend()):i!==void 0&&(i.clearAudioBuffer(),await d.resume()),te.emit("uiToggled",{visible:t.visible})}),window.addEventListener("blur",()=>{t.visible||y.call("toggleUI")});const h=d.createScriptProcessor(r,0,1);h.onaudioprocess=(()=>w=>{if(!t.visible){const _=w.outputBuffer.getChannelData(0);i.fillAudioBuffer(_,s)}})(),h.connect(d.destination),y.register("input",(w,_)=>{_&&t.onAction(w)});const g=w=>{t.onKeyDown(w.key)?w.preventDefault():f==null||f.onKeyDown(w)},p=w=>{f==null||f.onKeyUp(w)};window.addEventListener("keydown",g),window.addEventListener("keyup",p),window.addEventListener("gamepadconnected",f.onGamepadConnected),window.addEventListener("gamepaddisconnected",f.onGamepadDisconnected);function b(w){i=H.new(w,d.sampleRate),l.fill(0)}async function S(w){if(w!=null)try{const _=await e.db.rom.get(w);return b(_.data),!0}catch(_){console.error("Could not load ROM:",_),t.alert({text:`${_}`,type:"error",frames:2.5*60}),e.set("rom",null)}return!1}e.subscribe("rom",async(w,_)=>{w!=null&&(w!==_?await S(w)&&y.call("toggleUI"):y.call("toggleUI"))}),y.register("loadSave",async w=>{const _=await e.db.save.get(w);m(()=>{i.loadState(_.state),y.call("toggleUI",!1)})}),y.register("loadLastSave",async()=>{const w=await e.db.save.getLast(e.ref.rom);w!=null&&m(()=>{i.loadState(w.state),y.call("toggleUI",!1)})}),y.register("saveState",async()=>{const w=i.saveState(),_=await e.db.save.insert(e.ref.rom,w);return te.emit("saved",{timestamp:_}),w});function I(w,_){const E=i.saveState();i.loadState(w),i.nextFrame(_),i.loadState(E)}y.register("setBackground",async w=>{switch(w.mode){case"current":{l.set(c);break}case"at":{const _=await e.db.save.get(w.timestamp);I(_.state,l);break}case"titleScreen":{if(e.ref.rom===w.hash)l.set(c);else{const _=await e.db.titleScreen.get(w.hash);_!=null?l.set(_.data):l.fill(0)}break}}t.screen.setBackground(l,.2),o.render(l)});async function U(){e.ref.rom!=null&&(await S(e.ref.rom),i&&e.ref.lastState!=null&&(i.loadState(e.ref.lastState),i.nextFrame(c),i.loadState(e.ref.lastState),y.call("setBackground",{mode:"current"}))),R()}const O=new Uint8Array(N*B*3);y.register("generateTitleScreen",async w=>{try{const _=await e.db.rom.get(w),E=await e.db.titleScreen.get(w);if(E==null){const W=H.new(_.data,d.sampleRate);for(let le=0;le<120;le++)W.nextFrame(O);return await e.db.titleScreen.insert(w,O),O}else return E.data}catch(_){return console.error(`Failed to generate title screen for ${w}: ${_}`),O.fill(0),O}}),y.register("toggleFullscreen",()=>{document.fullscreenElement?document.exitFullscreen():a.requestFullscreen()}),y.register("softReset",()=>{i==null||i.softReset()}),y.register("setJoypad1",w=>{t.visible||i==null||i.setJoypad1(w)});function A(){i!=null&&(e.ref.lastState=i.saveState()),e.save()}function R(){requestAnimationFrame(R),f.tick(),t.visible?(t.render(l),o.render(l)):i!==void 0&&(i.nextFrame(l),o.render(l))}await U(),window.addEventListener("beforeunload",A)}window.addEventListener("DOMContentLoaded",kt);
